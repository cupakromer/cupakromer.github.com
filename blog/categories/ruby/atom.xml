<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: ruby | Aaron Kromer's Blog]]></title>
  <link href="http://cupakromer.github.com/blog/categories/ruby/atom.xml" rel="self"/>
  <link href="http://cupakromer.github.com/"/>
  <updated>2014-04-10T12:31:28-04:00</updated>
  <id>http://cupakromer.github.com/</id>
  <author>
    <name><![CDATA[Aaron Kromer]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Pitfalls of Testing Scripts With Load - Part 2]]></title>
    <link href="http://cupakromer.github.com/blog/2014-02-17-pitfalls-of-testing-scripts-with-load-part-2.html"/>
    <updated>2014-02-17T10:15:00-05:00</updated>
    <id>http://cupakromer.github.com/blog/pitfalls-of-testing-scripts-with-load-part-2</id>
    <content type="html"><![CDATA[<p>File /Users/aaron/dev/cupakromer/cupakromer.github.com/source/<em>posts/</em>pitfalls_of_test_load_posts.md could not be found</p>

<h2>Scope Smashing</h2>

<p>Take the following script and spec:</p>

<p>```ruby</p>

<h1>!/usr/bin/env ruby</h1>

<p>def current_user
  'Bob'
end
```</p>

<p>```ruby
require 'spec_helper'</p>

<p>def current_user
  'Alice'
end</p>

<p>describe 'Running the server locally' do
  it 'logs that it is running' do</p>

<pre><code>load 'script/current-user-smash'

expect(current_user).to eq 'Alice'
</code></pre>

<p>  end
end
```</p>

<p>Alas, the spec fails with:</p>

<p>```
expected: "Alice"</p>

<pre><code> got: "Bob"
</code></pre>

<p>```</p>

<p>This is due to how <a href="http://ruby-doc.org/core-2.1.0/Kernel.html#method-i-load"><code>load</code></a> works:</p>

<blockquote><p>If the optional <code>wrap</code> parameter is <code>true</code>, the loaded script will be
executed under an anonymous module, protecting the calling programâ€™s global
namespace. In no circumstance will any local variables in the loaded file be
propagated to the loading environment.</p></blockquote>

<p>While it is easy to spot the issue this time, that's not normally the case.
Say if the additional method is define by a gem or in supporting file. Or if
you are testing multiple scripts that each define the same top-level methods.
These conditions will result in very strange and difficult to debug failures.
Of course, it's always a good idea to not define top-level methods to begin
with.</p>

<p>Instead always pass the additional <code>wrap</code> parameter. Here I've named it as a
descriptive inline variable to reveal it's intent:</p>

<p>```ruby
it 'logs that it is running' do
  load 'script/current-user-smash', _in_sandbox = true</p>

<p>  expect(current_user).to eq 'Alice'
end
```</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Discussion about open classes and monkey patching at #retroruby]]></title>
    <link href="http://cupakromer.github.com/blog/2014-02-06-open-classes-and-monkey-patching-at-retroruby.html"/>
    <updated>2014-02-06T15:28:00-05:00</updated>
    <id>http://cupakromer.github.com/blog/open-classes-and-monkey-patching-at-retroruby</id>
    <content type="html"><![CDATA[<p>While at <a href="http://retroruby.org">RetroRuby 2014</a> a very good question was asked
in the newbie track. The following code sample had just been shown on some
basic awesomeness of Ruby:</p>

<p>```ruby
"Words" * 2</p>

<h1>=> "WordsWords"</h1>

<p>```</p>

<p>One of the participants then asked why that worked but the inverse didn't:</p>

<p>```ruby
2 * "Words"</p>

<h1>TypeError: String can't be coerced into Fixnum</h1>

<p>```</p>

<h2>Oops what just happened?</h2>

<p>In Ruby, virtually everything is accomplished by sending a message to another
object. Above we would say:</p>

<blockquote><p><em>Send the message <code>*</code> to <code>"Words"</code> with parameter <code>2</code></em></p>

<p><em>Send the message <code>*</code> to <code>2</code> with parameter <code>"Words"</code></em></p></blockquote>

<p>"Sending a message" is the Java equivalent of calling a method. Another way to
write the above is:</p>

<p>```ruby
"Words".*(2)</p>

<h1>=> "WordsWords"</h1>

<p>```</p>

<p>Here we used the normal "method" calling syntax: <code>obj.method(args)</code></p>

<p>You'll also probably see the following:</p>

<p>```ruby
"Words".send(:*, 2)</p>

<h1>=> "WordsWords"</h1>

<p>```</p>

<p>This time we explicitly sent the message: <code>obj.send(message, args)</code></p>

<p>With <a href="http://ruby-doc.org/core-2.1.0/Object.html#method-i-send"><code>send</code></a> Ruby
doesn't check if the message you passed was supposed to be public or private.
Generally, what you wanted to do was dynamically send the message while still
making sure to respect the public API of the object. To do this you should use
<a href="http://ruby-doc.org/core-2.1.0/Object.html#method-i-public_send"><code>public_send</code></a>
instead: <code>obj.public_send(message, args)</code>.</p>

<p>So back to the original issue. Both
<a href="http://ruby-doc.org/core-2.1.0/String.html"><code>String</code></a> and
<a href="http://ruby-doc.org/core-2.1.0/Fixnum.html"><code>Fixnum</code></a> respond to the message
<code>*</code>.</p>

<ul>
<li><a href="http://ruby-doc.org/core-2.1.0/String.html#method-i-2A"><code>String#*</code></a></li>
<li><a href="http://ruby-doc.org/core-2.1.0/Fixnum.html#method-i-2A"><code>Fixnum#*</code></a></li>
</ul>


<p>However, <code>String</code>'s implementation knows what to do when the argument is a
<code>Fixnum</code>. When we reverse it, the <code>Fixnum</code> implementation doesn't understand
what to do with a <code>String</code> argument.</p>

<h2>How to fix this?</h2>

<p>Well you probably shouldn't. But just for fun we'll use Ruby's open class
behavior to monkey patch <code>Fixnum</code>'s <code>*</code> implementation.</p>

<p>```ruby
class Fixnum # We just re-opened the class</p>

<p>  def *(arg) # We're redefining the * message - this destroys the</p>

<pre><code>         # previous implementation!!!
arg * self
</code></pre>

<p>  end</p>

<p>end</p>

<p>2 * "Words"</p>

<h1>=> WordsWords</h1>

<p>```</p>

<p>It worked!! Before you go doing this to everything, be aware we've now lost the
ability to do normal multiplication. Additionally, we'll overflow the stack
trying to multiply two <code>Fixnum</code>s.</p>

<p>```ruby
2 * 2</p>

<h1>SystemStackError: stack level too deep</h1>

<p>```</p>

<h2>Wrap Up</h2>

<p>In Ruby, most things are messages sent from one object to another. Some times
the language gives a little extra syntactic sugar to make sending the message
more readable.</p>

<p>Additionally, open classes and monkey patching have their uses. Just be aware
that with great power comes great responsibility. Always stop to ask yourself
if this is really a good idea; and try to never change existing behavior if you
can.</p>

<h2>Level Up!</h2>

<p>So what if we just wanted to extend the existing functionality.  There are a
lot of ways to do this and covering each, along with the pros and cons is very
out of scope for this post. I'm just going to demonstrate one way to illustrate
how it could be done.</p>

<p>You'll need a new irb or Pry session so we get the original implementation for
<code>Fixnum</code> back.</p>

<p>```ruby
class Fixnum # We just re-opened the class</p>

<p>  # We need to store a reference to the original implementation One way to do
  # this is to create an alias for the original implementation so we can call
  # it later. Be sure to pick a descriptive name so that it isn't accidentally
  # overwritten by something else.
  alias :star_without_string_support :*</p>

<p>  def *(arg) # Redefine the message destroying the previous implementation!!!</p>

<pre><code>if arg.is_a? String
  arg * self
else
  star_without_string_support arg  # use the original implementation
end
</code></pre>

<p>  end</p>

<p>end
```</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Live-ing Dangerously with Rails]]></title>
    <link href="http://cupakromer.github.com/blog/2013-12-10-live-ing-dangerously-with-rails.html"/>
    <updated>2013-12-10T13:08:00-05:00</updated>
    <id>http://cupakromer.github.com/blog/live-ing-dangerously-with-rails</id>
    <content type="html"><![CDATA[<p>Recently at work, we've been spinning up a bunch of demo apps on Heroku. This
has worked out well for us so far. However, some of these apps require
background data crunching. This hasn't been a problem as we just add a Rake
task, or two, and set the Heroku scheduler to take care of things.</p>

<p>Then comes the day when the sales team says:</p>

<blockquote><p>"Oh hey. Can we re-run all the numbers but with different configurations?"</p></blockquote>

<p>Sure, that's not a problem you think:</p>

<p><code>bash
$ heroku run rake redo_all_the_things[config.yml]
</code></p>

<p>However, there's a few issues with this:</p>

<ol>
<li>The <code>config.yml</code> needs to be on Heroku</li>
<li>This counts against your active dyno time</li>
</ol>


<p>See the thing is, Heroku <a href="https://devcenter.heroku.com/articles/read-only-filesystem">doesn't let you create files</a>
that aren't already in your VC system from outside the app. It's now
<a href="https://devcenter.heroku.com/articles/dynos#ephemeral-filesystem">sorta possible on Cedar</a>,
but not really for this purpose.</p>

<p>Additionally, if these tasks turn out to be long running, that'll quickly eat
up the overhead on the 'free' dyno. For demo apps of non-paying customers
that's not always an option.</p>

<p>Enter the <code>live</code> environment.</p>

<p>Just add a new <code>live</code> environment to the Rails application. This allows us to
run Rake locally, but against the production database. Additionally, allowing
for custom configuration files to just be stored on our local system. And we
don't spin up a new dyno on Heroku.  Win, win!</p>

<p>To set this up:</p>

<ul>
<li>Update the <code>Gemfile</code></li>
</ul>


<p>```ruby</p>

<h1>Gemfile</h1>

<h1>We use dotenv-rails to help manage environment configs locally.</h1>

<h1>Add our new environment:</h1>

<p>gem 'dotenv-rails', groups: [:development, :test, :live]
```</p>

<ul>
<li>Add the live specific sample file: <code>.env.live-example</code></li>
</ul>


<p>```ruby</p>

<h1>.env.live-example</h1>

<h1>Rename this file to <code>.env.live</code> and it will be automatically sourced by</h1>

<h1>rails. Uncomment the settings for them to be picked up.</h1>

<p>#</p>

<h1>Grab the settings from the output of:</h1>

<p>#</p>

<h1>$ heroku config</h1>

<p>#</p>

<h1>Running against the Heroku production DB directly</h1>

<h1>BE CAREFUL!! YOU HAVE BEEN WARNED!!</h1>

<h1>DATABASE_NAME=WARNING</h1>

<h1>DATABASE_HOST=DANGER</h1>

<h1>DATABASE_PORT=WILL</h1>

<h1>DATABASE_USER=ROBINSON</h1>

<h1>DATABASE_PASSWORD=SERIOUSLY</h1>

<p>```</p>

<ul>
<li>Update the <code>database.yml</code> file</li>
</ul>


<p>```yaml</p>

<h1>config/database.yml</h1>

<p>live:
  adapter: postgresql
  encoding: unicode
  database: &lt;%= ENV['DATABASE_NAME'] %>
  host: &lt;%= ENV['DATABASE_HOST'] %>
  port: &lt;%= ENV['DATABASE_PORT'] %>
  username: &lt;%= ENV['DATABASE_USER'] %>
  password: &lt;%= ENV['DATABASE_PASSWORD'] %>
```</p>

<ul>
<li>Copy <code>config/environments/production.rb</code> to <code>config/environments/live.rb</code>.
If you wish to symlink it instead <a href="http://stackoverflow.com/questions/954560/what-does-git-do-to-files-that-are-a-symbolic-link">be wary of how git treats that</a>.</li>
</ul>


<p>Now running our tasks is as simple as:</p>

<p><code>bash
$ RAILS_ENV=live rake redo_all_the_things[config-fun-edition.yml]
</code></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Pitfalls of Testing Scripts With Load - Part 1]]></title>
    <link href="http://cupakromer.github.com/blog/2013-07-29-pitfalls-of-testing-scripts-with-load-part-1.html"/>
    <updated>2013-07-29T13:29:00-04:00</updated>
    <id>http://cupakromer.github.com/blog/pitfalls-of-testing-scripts-with-load-part-1</id>
    <content type="html"><![CDATA[<p>File /Users/aaron/dev/cupakromer/cupakromer.github.com/source/<em>posts/</em>pitfalls_of_test_load_posts.md could not be found</p>

<p>Previously it was shown how to <a href="http://aaronkromer.com/blog/2013-07-11-testing-scripts-with-load.html">use load to test scripts</a>. As with all techniques, there are some drawbacks to using <code>load</code>.</p>

<h2>Hidden Require Dependency</h2>

<p>Take script:</p>

<p>```ruby</p>

<h1>!/usr/bin/env ruby</h1>

<p>$:.unshift File.join File.dirname(<strong>FILE</strong>), "..", "lib"</p>

<p>require 'local_server'</p>

<p>logger = Logger.new($stderr)</p>

<p>LocalServer.new(logger).run
```</p>

<p>and passing spec:</p>

<p>```ruby
require 'spec_helper'
require 'logger'
require 'stringio'</p>

<p>describe 'Running the server locally' do
  it 'logs that it is running' do</p>

<pre><code>io = StringIO.new
allow(Logger).to receive(:new).and_return(Logger.new io)

expect{ load 'script/local-server' }.to change{ io.string }
  .to include 'SERVER: starting up'
</code></pre>

<p>  end
end
```</p>

<p>However, when the script is run standalone, it errors with:</p>

<p><code>
uninitialized constant Logger (NameError)
</code></p>

<p>Be aware that since <a href="http://ruby-doc.org/core-2.0/Kernel.html#method-i-load"><code>load</code></a>
happens in the current spec context, a missing <code>require</code> may not be noticed if
it is required by the spec.</p>

<p>Whenever possible have at least one test that shells out as a sanity check.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Monitoring Specific Messages in RSpec Part 3]]></title>
    <link href="http://cupakromer.github.com/blog/2013-07-26-monitoring-specific-messages-in-rspec-part-3.html"/>
    <updated>2013-07-26T10:13:00-04:00</updated>
    <id>http://cupakromer.github.com/blog/monitoring-specific-messages-in-rspec-part-3</id>
    <content type="html"><![CDATA[<p>File /Users/aaron/dev/cupakromer/cupakromer.github.com/source/<em>posts/</em>monitor_specific_messages_posts.md could not be found</p>

<p>Continuing the series (
<a href="http://aaronkromer.com/blog/2013-07-17-monitoring-specific-messages-in-rspec.html">part 1</a>,
<a href="http://aaronkromer.com/blog/2013-07-24-monitoring-specific-messages-in-rspec-part-2.html">part 2</a>
) on matching messages in RSpec, the next logical step is custom argument
matchers.</p>

<p><code>ruby
expect(mechanic).to receive(:fix).with something_broken
</code></p>

<p>Using the RSpec <a href="https://www.relishapp.com/rspec/rspec-expectations/v/2-14/docs/custom-matchers">matcher DSL</a>
this could simply look like:</p>

<p>```ruby
RSpec::Matchers.define :something_broken do
  match do |thing|</p>

<pre><code>thing.broken?
</code></pre>

<p>  end
end
```</p>

<p>That's all there is to it. Now it can be used as both a regular matcher and as
an argument matcher.</p>

<p>If the matcher needs to be created from
<a href="http://rubydoc.info/gems/rspec-expectations/RSpec/Matchers">scratch</a>, a
<code>matches?</code> method must be defined instead:</p>

<p>```ruby
class SomethingBroken
  def matches?(target)</p>

<pre><code>target.broken?
</code></pre>

<p>  end
end</p>

<p>def something_broken
  SomethingBroken.new
end
```</p>

<p>This works just fine as a normal matcher, however, when used as an argument
matcher, it will always fail. The reason is that argument matchers are invoked
with the <code>==</code> operator, which by <a href="http://ruby-doc.org/core-2.0/BasicObject.html#method-i-3D-3D">default</a>,
verifies if the objects are the same object.</p>

<p>Attempting to use a normal matcher with the
<a href="https://www.relishapp.com/rspec/rspec-expectations/v/2-14/docs/built-in-matchers/expect-change"><code>change</code></a>
expectation also
<a href="https://github.com/rspec/rspec-expectations/issues/276">oddly</a> fails, due to
<code>change</code> invoking the
<a href="http://aaronkromer.com/blog/2012-10-12-equals-equals-equals-the-forgotten-equality.html"><code>===</code></a>
message, not <code>matches?</code>. Since the <a href="http://ruby-doc.org/core-2.0/Object.html#method-i-3D-3D-3D">default <code>===</code> behavior is
<code>==</code></a>, the existing
argument matchers currently work with it.</p>

<p>There is active talk / changes
<a href="https://github.com/rspec/rspec-expectations/issues/280">happening</a> to
standardize the matchers to <code>===</code>. This will allow for a more consistent and
composable interface. It also has the added benefit of allowing the matchers to
be used in more complex conditionals using <code>case</code> statements.</p>

<p>To fix the class based matcher simply add the necessary alias(es):</p>

<p>```ruby
class SomethingBroken
  def matches?(target)</p>

<pre><code>target.broken?
</code></pre>

<p>  end
  alias_method :==, :matches?
  alias_method :===, :matches?  # Not technically necessary due to default ==
end
```</p>

<p>Note that with such a simple matcher, there is no reason it cannot be created
as a simple composed method using an existing matcher:</p>

<p><code>ruby
def something_broken
  be_broken   # Note: Not all built in matchers have == aliases yet
end
</code></p>
]]></content>
  </entry>
  
</feed>
