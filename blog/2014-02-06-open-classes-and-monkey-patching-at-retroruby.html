
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>Discussion about open classes and monkey patching at #retroruby - Aaron Kromer's Blog</title>
    <meta name="author" content="Aaron Kromer">
    
	<meta name="description" content="While at RetroRuby 2014 a very good question was asked
in the newbie track. The following code sample had just been shown on some
basic awesomeness &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="Aaron Kromer's Blog" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.ico" rel="shortcut icon">
    <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">

    <link href='http://fonts.googleapis.com/css?family=Slackey' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Amethysta' rel='stylesheet' type='text/css'>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
    <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

    <script type="text/javascript" src="/javascripts/jquery-tapir.js"></script>

    <!-- remove or comment it to disable ajaxification -->   
    <script src="/javascripts/ajaxify.js"></script>
   
    
    
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-34364108-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>


</head>


<body>
    <div id="wrapper">
    <header id="header" class="inner"><!-- for more effects see _animate.scss -->
<hgroup id="headerbg">
  <h1><a href="/">Aaron Kromer's Blog</a></h1>
  
    <h2>A little cup'a Kromer with your code</h2>
  
</hgroup>

<ul id="social-links">
  
  <!-- GitHub -->
  <li>
    <a href="https://github.com/cupakromer" title="GitHub">
      <i class="foundicon-github"></i>
    </a>
  </li>
  
  
  
  
  <!-- Twitter -->
  <li>
    <a href="http://www.twitter.com/cupakromer" title="Twitter">
      <i class="foundicon-twitter"></i>
    </a>
  </li>
  
  
  
  
  <li>
    <a href="/atom.xml">
      <i class="foundicon-rss"></i>
    </a>
  </li>
</ul>


<!-- use full url including 'index.html' for navigation bar if you are using ajax -->
<ul id="nav">
  <li id="ajax"><a href="/index.html">Home</a></li>
  <li id="ajax"><a href="/blog/archives/index.html">Archives</a></li>
  
  <li>
    <div id="dark">
      <form method="get" action="/search.html" id="search">
        <input name="query" type="text" placeholder="Search..." x-webkit-speech />
      </form>
    </div>
  </li>
  
</ul>




</header>

<div id="toload">
<!-- begin toload --> 
    <div id="content" class="inner">
        <article class="post">
	<h2 class="title">Discussion About Open Classes and Monkey Patching at #retroruby</h2>
	<div class="entry-content"><p>While at <a href="http://retroruby.org">RetroRuby 2014</a> a very good question was asked
in the newbie track. The following code sample had just been shown on some
basic awesomeness of Ruby:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="s2">&quot;Words&quot;</span> <span class="o">*</span> <span class="mi">2</span>
</span><span class='line'><span class="c1"># =&gt; &quot;WordsWords&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>One of the participants then asked why that worked but the inverse didn&#8217;t:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="mi">2</span> <span class="o">*</span> <span class="s2">&quot;Words&quot;</span>
</span><span class='line'><span class="c1"># TypeError: String can&#39;t be coerced into Fixnum</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Oops what just happened?</h2>

<p>In Ruby, virtually everything is accomplished by sending a message to another
object. Above we would say:</p>

<blockquote><p><em>Send the message <code>*</code> to <code>"Words"</code> with parameter <code>2</code></em></p>

<p><em>Send the message <code>*</code> to <code>2</code> with parameter <code>"Words"</code></em></p></blockquote>

<p>&#8220;Sending a message&#8221; is the Java equivalent of calling a method. Another way to
write the above is:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="s2">&quot;Words&quot;</span><span class="o">.</span><span class="n">*</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span class='line'><span class="c1"># =&gt; &quot;WordsWords&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here we used the normal &#8220;method&#8221; calling syntax: <code>obj.method(args)</code></p>

<p>You&#8217;ll also probably see the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="s2">&quot;Words&quot;</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="ss">:*</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span class='line'><span class="c1"># =&gt; &quot;WordsWords&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This time we explicitly sent the message: <code>obj.send(message, args)</code></p>

<p>With <a href="http://ruby-doc.org/core-2.1.0/Object.html#method-i-send"><code>send</code></a> Ruby
doesn&#8217;t check if the message you passed was supposed to be public or private.
Generally, what you wanted to do was dynamically send the message while still
making sure to respect the public API of the object. To do this you should use
<a href="http://ruby-doc.org/core-2.1.0/Object.html#method-i-public_send"><code>public_send</code></a>
instead: <code>obj.public_send(message, args)</code>.</p>

<p>So back to the original issue. Both
<a href="http://ruby-doc.org/core-2.1.0/String.html"><code>String</code></a> and
<a href="http://ruby-doc.org/core-2.1.0/Fixnum.html"><code>Fixnum</code></a> respond to the message
<code>*</code>.</p>

<ul>
<li><a href="http://ruby-doc.org/core-2.1.0/String.html#method-i-2A"><code>String#*</code></a></li>
<li><a href="http://ruby-doc.org/core-2.1.0/Fixnum.html#method-i-2A"><code>Fixnum#*</code></a></li>
</ul>


<p>However, <code>String</code>&#8217;s implementation knows what to do when the argument is a
<code>Fixnum</code>. When we reverse it, the <code>Fixnum</code> implementation doesn&#8217;t understand
what to do with a <code>String</code> argument.</p>

<h2>How to fix this?</h2>

<p>Well you probably shouldn&#8217;t. But just for fun we&#8217;ll use Ruby&#8217;s open class
behavior to monkey patch <code>Fixnum</code>&#8217;s <code>*</code> implementation.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Fixnum</span> <span class="c1"># We just re-opened the class</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">*</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="c1"># We&#39;re redefining the * message - this destroys the</span>
</span><span class='line'>             <span class="c1"># previous implementation!!!</span>
</span><span class='line'>    <span class="n">arg</span> <span class="o">*</span> <span class="nb">self</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="mi">2</span> <span class="o">*</span> <span class="s2">&quot;Words&quot;</span>
</span><span class='line'><span class="c1"># =&gt; WordsWords</span>
</span></code></pre></td></tr></table></div></figure>


<p>It worked!! Before you go doing this to everything, be aware we&#8217;ve now lost the
ability to do normal multiplication. Additionally, we&#8217;ll overflow the stack
trying to multiply two <code>Fixnum</code>s.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="mi">2</span> <span class="o">*</span> <span class="mi">2</span>
</span><span class='line'><span class="c1"># SystemStackError: stack level too deep</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Wrap Up</h2>

<p>In Ruby, most things are messages sent from one object to another. Some times
the language gives a little extra syntactic sugar to make sending the message
more readable.</p>

<p>Additionally, open classes and monkey patching have their uses. Just be aware
that with great power comes great responsibility. Always stop to ask yourself
if this is really a good idea; and try to never change existing behavior if you
can.</p>

<h2>Level Up!</h2>

<p>So what if we just wanted to extend the existing functionality.  There are a
lot of ways to do this and covering each, along with the pros and cons is very
out of scope for this post. I&#8217;m just going to demonstrate one way to illustrate
how it could be done.</p>

<p>You&#8217;ll need a new irb or Pry session so we get the original implementation for
<code>Fixnum</code> back.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Fixnum</span> <span class="c1"># We just re-opened the class</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># We need to store a reference to the original implementation One way to do</span>
</span><span class='line'>  <span class="c1"># this is to create an alias for the original implementation so we can call</span>
</span><span class='line'>  <span class="c1"># it later. Be sure to pick a descriptive name so that it isn&#39;t accidentally</span>
</span><span class='line'>  <span class="c1"># overwritten by something else.</span>
</span><span class='line'>  <span class="k">alias</span> <span class="ss">:star_without_string_support</span> <span class="ss">:*</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">*</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="c1"># Redefine the message destroying the previous implementation!!!</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">is_a?</span> <span class="nb">String</span>
</span><span class='line'>      <span class="n">arg</span> <span class="o">*</span> <span class="nb">self</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">star_without_string_support</span> <span class="n">arg</span>  <span class="c1"># use the original implementation</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

</div>

<div class="meta">
	
</div>
</article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	
	<a class="addthis_button_tweet"></a>
	
	
	<a class="addthis_counter addthis_pill_style"></a>
	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>



    </div>
    <footer id="footer">
    <div style="display:inline">
  <p>
    Copyright &copy; 2014

    Aaron Kromer
.
    All content on this site is available under a <a href="http://creativecommons.org/publicdomain/zero/1.0/">CC0 license</a>.
  </p>
  <p>
    Powered by <a href="http://octopress.org">Octopress</a> |
    Theme based on <a href="http://github.com/panks/fabric">fabric</a> by <a href="http://panks.me">Pankaj Kumar</a>
  </p>
</div>


    </footer>
    <script src="/javascripts/fabric.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->






<!-- end toload --> 
</div>
</div>
<script src="/javascripts/jquery.ui.totop.js" type="text/javascript"></script>
<script type="text/javascript">
/*<![CDATA[*/
;(function($){$().UItoTop({easingType:'easeOutCirc'});})(jQuery); 
/*]]>*/
</script><!-- remove it to remove the scroll to top button -->
</body>
</html>
