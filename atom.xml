<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Aaron Kromer's Blog]]></title>
  <link href="http://cupakromer.github.com/atom.xml" rel="self"/>
  <link href="http://cupakromer.github.com/"/>
  <updated>2013-12-10T13:22:20-05:00</updated>
  <id>http://cupakromer.github.com/</id>
  <author>
    <name><![CDATA[Aaron Kromer]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Live-ing Dangerously with Rails]]></title>
    <link href="http://cupakromer.github.com/blog/2013-12-10-live-ing-dangerously-with-rails.html"/>
    <updated>2013-12-10T13:08:00-05:00</updated>
    <id>http://cupakromer.github.com/blog/live-ing-dangerously-with-rails</id>
    <content type="html"><![CDATA[<p>Recently at work, we&#8217;ve been spinning up a bunch of demo apps on Heroku. This
has worked out well for us so far. However, some of these apps require
background data crunching. This hasn&#8217;t been a problem as we just add a Rake
task, or two, and set the Heroku scheduler to take care of things.</p>

<p>Then comes the day when the sales team says:</p>

<blockquote><p>&#8220;Oh hey. Can we re-run all the numbers but with different configurations?&#8221;</p></blockquote>

<p>Sure, that&#8217;s not a problem you think:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>heroku run rake redo_all_the_things<span class="o">[</span>config.yml<span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>However, there&#8217;s a few issues with this:</p>

<ol>
<li>The <code>config.yaml</code> needs to be on Heroku</li>
<li>This counts against your active dyno time</li>
</ol>


<p>See the thing is, Heroku <a href="https://devcenter.heroku.com/articles/read-only-filesystem">doesn&#8217;t let you create files</a>
that aren&#8217;t already in your VC system from outside the app. It&#8217;s now
<a href="https://devcenter.heroku.com/articles/dynos#ephemeral-filesystem">sorta possible on Cedar</a>,
but not really for this purpose.</p>

<p>Additionally, if these tasks turn out to be long running, that&#8217;ll quickly eat
up the overhead on the &#8216;free&#8217; dyno. For demo apps of non-paying customers
that&#8217;s not always an option.</p>

<p>Enter the <code>live</code> environment.</p>

<p>Just add a new <code>live</code> environment to the Rails application. This allows us to
run Rake locally, but against the production database. Additionally, allowing
for custom configuration files to just be stored on our local system. And we
don&#8217;t spin up a new dyno on Heroku.  Win, win!</p>

<p>To setup this up:</p>

<ul>
<li>Update the <code>Gemfile</code></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Gemfile</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># We use dotenv-rails to help manage environment configs locally.</span>
</span><span class='line'><span class="c1"># Add our new environment:</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;dotenv-rails&#39;</span><span class="p">,</span> <span class="ss">groups</span><span class="p">:</span> <span class="o">[</span><span class="ss">:development</span><span class="p">,</span> <span class="ss">:test</span><span class="p">,</span> <span class="ss">:live</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Add the live specific sample file: <code>.env.live-example</code></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># .env.live-example</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Rename this file to `.env.live` and it will be automatically sourced by</span>
</span><span class='line'><span class="c1"># rails. Uncomment the settings for them to be picked up.</span>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="c1"># Grab the settings from the output of:</span>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="c1">#  $ heroku config</span>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="c1"># Running against the Heroku production DB directly</span>
</span><span class='line'><span class="c1"># BE CAREFUL!! YOU HAVE BEEN WARNED!!</span>
</span><span class='line'><span class="c1">#DATABASE_NAME=WARNING</span>
</span><span class='line'><span class="c1">#DATABASE_HOST=DANGER</span>
</span><span class='line'><span class="c1">#DATABASE_PORT=WILL</span>
</span><span class='line'><span class="c1">#DATABASE_USER=ROBINSON</span>
</span><span class='line'><span class="c1">#DATABASE_PASSWORD=SERIOUSLY</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Update the <code>database.yml</code> file</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="c1"># config/database.yml</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">live</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">adapter</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">postgresql</span>
</span><span class='line'>  <span class="l-Scalar-Plain">encoding</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">unicode</span>
</span><span class='line'>  <span class="l-Scalar-Plain">database</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= ENV[&#39;DATABASE_NAME&#39;] %&gt;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">host</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= ENV[&#39;DATABASE_HOST&#39;] %&gt;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">port</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= ENV[&#39;DATABASE_PORT&#39;] %&gt;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">username</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= ENV[&#39;DATABASE_USER&#39;] %&gt;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">password</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= ENV[&#39;DATABASE_PASSWORD&#39;] %&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Copy <code>config/environments/production.rb</code> to <code>config/environments/live.rb</code>.
If you wish to symlink it instead <a href="http://stackoverflow.com/questions/954560/what-does-git-do-to-files-that-are-a-symbolic-link">be wary of how git treats that</a>.</li>
</ul>


<p>Now running our tasks is as simple as:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ RAILS_ENV</span><span class="o">=</span>live rake redo_all_the_things<span class="o">[</span>config-fun-edition.yml<span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Pitfalls of Testing Scripts With Load - Part 1]]></title>
    <link href="http://cupakromer.github.com/blog/2013-07-29-pitfalls-of-testing-scripts-with-load-part-1.html"/>
    <updated>2013-07-29T13:29:00-04:00</updated>
    <id>http://cupakromer.github.com/blog/pitfalls-of-testing-scripts-with-load-part-1</id>
    <content type="html"><![CDATA[<p>Previously it was shown how to <a href="http://aaronkromer.com/blog/2013-07-11-testing-scripts-with-load.html">use load to test scripts</a>. As with all techniques, there are some drawbacks to using <code>load</code>.</p>

<h3>Hidden Require Dependency</h3>

<p>Take script:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#!/usr/bin/env ruby</span>
</span><span class='line'><span class="vg">$:</span><span class="o">.</span><span class="n">unshift</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span> <span class="no">File</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">__FILE__</span><span class="p">),</span> <span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;lib&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;local_server&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">logger</span> <span class="o">=</span> <span class="no">Logger</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vg">$stderr</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="no">LocalServer</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">logger</span><span class="p">)</span><span class="o">.</span><span class="n">run</span>
</span></code></pre></td></tr></table></div></figure>


<p>and passing spec:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;logger&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;stringio&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">describe</span> <span class="s1">&#39;Running the server locally&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">it</span> <span class="s1">&#39;logs that it is running&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">io</span> <span class="o">=</span> <span class="no">StringIO</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>    <span class="n">allow</span><span class="p">(</span><span class="no">Logger</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:new</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="no">Logger</span><span class="o">.</span><span class="n">new</span> <span class="n">io</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">expect</span><span class="p">{</span> <span class="nb">load</span> <span class="s1">&#39;script/local-server&#39;</span> <span class="p">}</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">{</span> <span class="n">io</span><span class="o">.</span><span class="n">string</span> <span class="p">}</span>
</span><span class='line'>      <span class="o">.</span><span class="n">to</span> <span class="kp">include</span> <span class="s1">&#39;SERVER: starting up&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>However, when the script is run standalone, it errors with:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">uninitialized</span> <span class="n">constant</span> <span class="no">Logger</span> <span class="p">(</span><span class="no">NameError</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Be aware that since <a href="http://ruby-doc.org/core-2.0/Kernel.html#method-i-load"><code>load</code></a>
happens in the current spec context, a missing <code>require</code> may not be noticed if
it is required by the spec.</p>

<p>Whenever possible have at least one test that shells out as a sanity check.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Monitoring Specific Messages in RSpec Part 3]]></title>
    <link href="http://cupakromer.github.com/blog/2013-07-26-monitoring-specific-messages-in-rspec-part-3.html"/>
    <updated>2013-07-26T10:13:00-04:00</updated>
    <id>http://cupakromer.github.com/blog/monitoring-specific-messages-in-rspec-part-3</id>
    <content type="html"><![CDATA[<p>Continuing the series (
<a href="http://aaronkromer.com/blog/2013-07-17-monitoring-specific-messages-in-rspec.html">part 1</a>,
<a href="http://aaronkromer.com/blog/2013-07-24-monitoring-specific-messages-in-rspec-part-2.html">part 2</a>
) on matching messages in RSpec, the next logical step is custom argument
matchers.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">expect</span><span class="p">(</span><span class="n">mechanic</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:fix</span><span class="p">)</span><span class="o">.</span><span class="n">with</span> <span class="n">something_broken</span>
</span></code></pre></td></tr></table></div></figure>


<p>Using the RSpec <a href="https://www.relishapp.com/rspec/rspec-expectations/v/2-14/docs/custom-matchers">matcher DSL</a>
this could simply look like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="ss">RSpec</span><span class="p">:</span><span class="ss">:Matchers</span><span class="o">.</span><span class="n">define</span> <span class="ss">:something_broken</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">match</span> <span class="k">do</span> <span class="o">|</span><span class="n">thing</span><span class="o">|</span>
</span><span class='line'>    <span class="n">thing</span><span class="o">.</span><span class="n">broken?</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>That&#8217;s all there is to it. Now it can be used as both a regular matcher and as
an argument matcher.</p>

<p>If the matcher needs to be created from
<a href="http://rubydoc.info/gems/rspec-expectations/RSpec/Matchers">scratch</a>, a
<code>matches?</code> method must be defined instead:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">SomethingBroken</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">matches?</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
</span><span class='line'>    <span class="n">target</span><span class="o">.</span><span class="n">broken?</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">something_broken</span>
</span><span class='line'>  <span class="no">SomethingBroken</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This works just fine as a normal matcher, however, when used as an argument
matcher, it will always fail. The reason is that argument matchers are invoked
with the <code>==</code> operator, which by <a href="http://ruby-doc.org/core-2.0/BasicObject.html#method-i-3D-3D">default</a>,
verifies if the objects are the same object.</p>

<p>Attempting to use a normal matcher with the
<a href="https://www.relishapp.com/rspec/rspec-expectations/v/2-14/docs/built-in-matchers/expect-change"><code>change</code></a>
expectation also
<a href="https://github.com/rspec/rspec-expectations/issues/276">oddly</a> fails, due to
<code>change</code> invoking the
<a href="http://aaronkromer.com/blog/2012-10-12-equals-equals-equals-the-forgotten-equality.html"><code>===</code></a>
message, not <code>matches?</code>. Since the <a href="http://ruby-doc.org/core-2.0/Object.html#method-i-3D-3D-3D">default <code>===</code> behavior is
<code>==</code></a>, the existing
argument matchers currently work with it.</p>

<p>There is active talk / changes
<a href="https://github.com/rspec/rspec-expectations/issues/280">happening</a> to
standardize the matchers to <code>===</code>. This will allow for a more consistent and
composable interface. It also has the added benefit of allowing the matchers to
be used in more complex conditionals using <code>case</code> statements.</p>

<p>To fix the class based matcher simply add the necessary alias(es):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">SomethingBroken</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">matches?</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
</span><span class='line'>    <span class="n">target</span><span class="o">.</span><span class="n">broken?</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="n">alias_method</span> <span class="ss">:==</span><span class="p">,</span> <span class="ss">:matches?</span>
</span><span class='line'>  <span class="n">alias_method</span> <span class="ss">:===</span><span class="p">,</span> <span class="ss">:matches?</span>  <span class="c1"># Not technically necessary due to default ==</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note that with such a simple matcher, there is no reason it cannot be created
as a simple composed method using an existing matcher:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">something_broken</span>
</span><span class='line'>  <span class="n">be_broken</span>   <span class="c1"># Note: Not all built in matchers have == aliases yet</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Monitoring Specific Messages in RSpec Part 2]]></title>
    <link href="http://cupakromer.github.com/blog/2013-07-24-monitoring-specific-messages-in-rspec-part-2.html"/>
    <updated>2013-07-24T10:11:00-04:00</updated>
    <id>http://cupakromer.github.com/blog/monitoring-specific-messages-in-rspec-part-2</id>
    <content type="html"><![CDATA[<p><a href="http://aaronkromer.com/blog/2013-07-17-monitoring-specific-messages-in-rspec.html">Last time</a> it was demonstrated how it is possible to monitor only a desired
message expectations. While that technique is useful for a vast majority of
use cases, sometimes you need a bit more complexity.</p>

<p>Say for example, the desire is to verify the state of the provided parameter.
As in this very contrived example (<em>Update: 2013-07-28 Paired down example to
only show test and not implementation</em>):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">describe</span> <span class="no">Factory</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">context</span> <span class="s1">&#39;making sure current stock is ready&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">it</span> <span class="s1">&#39;only fixes broken widgets&#39;</span> <span class="k">do</span>
</span><span class='line'>      <span class="c1"># Setup code</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">states</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>      <span class="n">expect</span><span class="p">(</span><span class="n">mechanic</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:fix</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">widget</span><span class="o">|</span>
</span><span class='line'>        <span class="n">states</span> <span class="o">&lt;&lt;</span> <span class="n">widget</span><span class="o">.</span><span class="n">broken?</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">expect</span><span class="p">{</span> <span class="n">factory</span><span class="o">.</span><span class="n">perform_maintenance</span> <span class="p">}</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">{</span><span class="n">states</span><span class="p">}</span><span class="o">.</span><span class="n">to</span> <span class="o">[</span><span class="kp">true</span><span class="o">]</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This leverages the <a href="https://www.relishapp.com/rspec/rspec-mocks/v/2-14/docs/method-stubs/stub-with-substitute-implementation">stub with substitute implementation</a>
provided by RSpec mocks. It can also be used with the <code>allow</code> syntax.</p>

<p>While the above version has it&#8217;s uses, it tends to hide some of the intent in
the closure manipulation. A slightly more expressive method is just to add
the state expectation in the block:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">expect</span><span class="p">(</span><span class="n">mechanic</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:fix</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">widget</span><span class="o">|</span>
</span><span class='line'>  <span class="n">expect</span><span class="p">(</span><span class="n">widget</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">be_broken</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This last technique is great for setting up generic message stubs which require
that something with specific state is provided. By adding it to a generic
<code>allow</code>, it ensures when the contract is broken anywhere in the code under test,
the test will properly fail. (<em>Update 2013-07-30: seems there is an
<a href="https://github.com/rspec/rspec-mocks/pull/382">issue</a> with this technique when
combined with
<a href="https://www.relishapp.com/rspec/rspec-mocks/v/2-14/docs/message-expectations/calling-the-original-method"><code>and_call_original</code></a></em>)</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Monitoring Specific Messages in RSpec]]></title>
    <link href="http://cupakromer.github.com/blog/2013-07-17-monitoring-specific-messages-in-rspec.html"/>
    <updated>2013-07-17T11:34:00-04:00</updated>
    <id>http://cupakromer.github.com/blog/monitoring-specific-messages-in-rspec</id>
    <content type="html"><![CDATA[<p>A common question I see asked in the #rspec IRC channel is:</p>

<blockquote><p>How do I verify only a specific message is received?</p></blockquote>

<p>The context of this question is usually a method that sends the same message
multiple time, but with different arguments.</p>

<p>Take the following contrived example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">do_stuff</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span>
</span><span class='line'>  <span class="n">thing</span><span class="o">.</span><span class="n">do</span> <span class="ss">:having_fun</span>
</span><span class='line'>  <span class="n">thing</span><span class="o">.</span><span class="n">do</span> <span class="ss">:drink_coffee</span>
</span><span class='line'>  <span class="n">thing</span><span class="o">.</span><span class="n">do</span> <span class="ss">:code</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">describe</span> <span class="s1">&#39;Coffee time!&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">it</span> <span class="s1">&#39;drinks the coffee&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">thing</span> <span class="o">=</span> <span class="n">double</span><span class="p">(</span><span class="s1">&#39;Thing&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">expect</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:do</span><span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="ss">:drink_coffee</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">do_stuff</span> <span class="n">thing</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Alas, it fails:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>Double &quot;Thing&quot; received :do with unexpected arguments
</span><span class='line'>         expected: (:drink_coffee)
</span><span class='line'>              got: (:having_fun)
</span></code></pre></td></tr></table></div></figure>


<p>The solution is to add a generic stub (a catchall) for the desired message:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">describe</span> <span class="s1">&#39;Coffee time!&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">it</span> <span class="s1">&#39;drinks the coffee&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">thing</span> <span class="o">=</span> <span class="n">double</span><span class="p">(</span><span class="s1">&#39;Thing&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">allow</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:do</span><span class="p">)</span>
</span><span class='line'>    <span class="n">expect</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:do</span><span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="ss">:drink_coffee</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">do_stuff</span> <span class="n">thing</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>There is another solution which can also be used:
<a href="https://www.relishapp.com/rspec/rspec-mocks/v/2-14/docs/method-stubs/as-null-object"><code>as_null_object</code></a>.</p>

<p>The issue with <code>as_null_object</code> is that it will happily hum along even for
invalid and unexpected messages. The double stub pattern above is
explicit in the test, matching the catchall only with the message expectation.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">describe</span> <span class="s1">&#39;Coffee time!&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">it</span> <span class="s1">&#39;drinks the coffee&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">thing</span> <span class="o">=</span> <span class="n">double</span><span class="p">(</span><span class="s1">&#39;Thing&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">as_null_object</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">expect</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:do</span><span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="ss">:drink_coffee</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">do_stuff</span> <span class="n">thing</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Stay tuned for <a href="http://myronmars.to/n/dev-blog/2013/07/the-plan-for-rspec-3">RSpec3</a>
when <code>as_null_object</code> doubles will be smart enough to only stub matching
messages.  Or check out one of the many plugins:
<a href="https://github.com/xaviershay/rspec-fire"><code>rspec-fire</code></a>,
<a href="https://github.com/psyho/bogus"><code>bogus</code></a>, and
<a href="https://github.com/ryanong/spy"><code>spy</code></a>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Testing Scripts with Load]]></title>
    <link href="http://cupakromer.github.com/blog/2013-07-11-testing-scripts-with-load.html"/>
    <updated>2013-07-11T12:44:00-04:00</updated>
    <id>http://cupakromer.github.com/blog/testing-scripts-with-load</id>
    <content type="html"><![CDATA[<p>A standard method for testing Ruby scripts is to shell out to the script using
<a href="http://ruby-doc.org/core-2.0/Kernel.html#method-i-60"><code>Kernel#`</code></a>
or <a href="http://ruby-doc.org/core-2.0/Kernel.html#method-i-system"><code>Kernel#system</code></a>.
Both of these follow a <a href="http://ruby-doc.org/core-2.0/Kernel.html#method-i-fork"><code>fork</code></a>
and <a href="http://ruby-doc.org/core-2.0/Kernel.html#method-i-exec"><code>exec</code></a> pattern to
run the command.</p>

<p>However, there are instances where it is necessary to mock/stub something in
the script.  The above technique fails in this situation due to <code>exec</code>
replacing the current process; the stubs simply cease to exist.</p>

<p>The solution: use <a href="http://ruby-doc.org/core-2.0/Kernel.html#method-i-load"><code>load</code></a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Script</span>
</span><span class='line'><span class="c1">#!/usr/bin/env ruby</span>
</span><span class='line'><span class="vg">$:</span><span class="o">.</span><span class="n">unshift</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span> <span class="no">File</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">__FILE__</span><span class="p">),</span> <span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;lib&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;logger&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;monitor&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;pathname&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;temperature_api&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;tracker&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">logger</span>    <span class="o">=</span> <span class="no">Logger</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vg">$stderr</span><span class="p">)</span>
</span><span class='line'><span class="n">file_path</span> <span class="o">=</span> <span class="no">Pathname</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">ARGV</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'><span class="n">tracker</span>   <span class="o">=</span> <span class="no">Tracker</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">backup</span><span class="p">:</span> <span class="n">file_path</span><span class="p">)</span>
</span><span class='line'><span class="n">api</span>       <span class="o">=</span> <span class="no">TemperatureApi</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;api.server.com&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="no">Monitor</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">tracker</span><span class="p">,</span> <span class="n">api</span><span class="p">,</span> <span class="n">logger</span><span class="p">)</span><span class="o">.</span><span class="n">run</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Spec</span>
</span><span class='line'><span class="n">describe</span> <span class="s1">&#39;Monitoring cpu heat&#39;</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">it</span> <span class="s1">&#39;uploads the temperature to the server&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">stub_const</span><span class="p">(</span><span class="s1">&#39;ARGV&#39;</span><span class="p">,</span> <span class="o">[</span><span class="s1">&#39;monitor-integration.bak&#39;</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="n">stub_request</span><span class="p">(</span><span class="ss">:put</span><span class="p">,</span> <span class="s1">&#39;https://api.server.com/temp&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_return</span><span class="p">(</span><span class="ss">status</span><span class="p">:</span> <span class="mi">200</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">expect</span><span class="p">(</span><span class="nb">load</span> <span class="s1">&#39;script/monitor&#39;</span><span class="p">)</span>
</span><span class='line'>      <span class="o">.</span><span class="n">to</span> <span class="n">have_requested</span><span class="p">(</span><span class="ss">:put</span><span class="p">,</span> <span class="s1">&#39;https://api.server.com/temp&#39;</span><span class="p">)</span>
</span><span class='line'>      <span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="ss">body</span><span class="p">:</span> <span class="sr">/\A{&quot;temp&quot;:\d+}\z/</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>In conclusion, no more excuses for not have integration tests for your scripts.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[The Bang is for Surprise]]></title>
    <link href="http://cupakromer.github.com/blog/2013-05-19-the-bang-is-for-surprise.html"/>
    <updated>2013-05-19T21:20:00-04:00</updated>
    <id>http://cupakromer.github.com/blog/the-bang-is-for-surprise</id>
    <content type="html"><![CDATA[<p><strong><em>Note:</em></strong> I&#8217;m using Ruby 2.0.0 and RSpec 2.13.1 for these samples. Behavior
may be slightly different in older versions. YMMV!</p>

<p>One of the more well known features of <a href="github.com/rspec/rspec-core">RSpec</a> is
<a href="https://www.relishapp.com/rspec/rspec-core/v/2-13/docs/helper-methods/let-and-let!"><code>let</code></a>.
It provides a way to create a variable as a
<a href="http://devblog.avdi.org/2012/10/01/barewords/">bareword</a> which is lazy loaded
and memoized.</p>

<p>It also has a sibling <code>let!</code>. On the surface, <code>let!</code> is just a <code>let</code> without
the lazy loading. So any variable defined with a <code>let!</code> will always be created
before a test. This tool has a few nuances that should be know before you reach
for it.</p>

<p>Take the following sample. <em>What do you think the result will be?</em></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">describe</span> <span class="s2">&quot;Which one wins?&quot;</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">let!</span><span class="p">(</span><span class="ss">:sample</span><span class="p">)</span> <span class="p">{</span> <span class="s2">&quot;using let bang!&quot;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">context</span> <span class="s2">&quot;inside a context&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">let</span><span class="p">(</span><span class="ss">:sample</span><span class="p">)</span> <span class="p">{</span> <span class="s2">&quot;normal let&quot;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">it</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span> <span class="s2">&quot;normal let&quot;</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The test passes. This may or may not have been surprising. The rules for nested
<code>let</code>s, is that the <code>let</code> defined closet to the test in the hierarchy wins.
But, didn&#8217;t I say <code>let!</code> always created the object which was then memoized?</p>

<p>I&#8217;ll get to more about how <code>let</code> and <code>let!</code> are implemented in a minute. For
now, I want to point out a subtle surprise waiting for you; or possibly bring
to light that nagging itch at the back of your brain.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">describe</span> <span class="s2">&quot;Using Conflicting Let and Let!&quot;</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">let!</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="n">create</span> <span class="ss">:user</span><span class="p">,</span> <span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;bob&#39;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># LOTS OF CODE SO YOU CAN&#39;T SEE THE ABOVE LINE</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">context</span> <span class="s2">&quot;inside a context&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="n">create</span> <span class="ss">:user</span><span class="p">,</span> <span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;alice&#39;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Will this pass?</span>
</span><span class='line'>    <span class="n">it</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">expect</span><span class="p">(</span><span class="no">User</span><span class="o">.</span><span class="n">count</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span> <span class="mi">0</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Surprise! The test fails:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>  1) Which one wins? inside a context
</span><span class='line'>     Failure/Error: expect(User.count).to eq 0
</span><span class='line'>
</span><span class='line'>       expected: 0
</span><span class='line'>            got: 1
</span><span class='line'>
</span><span class='line'>       (compared using ==)
</span></code></pre></td></tr></table></div></figure>


<p><a href="https://www.destroyallsoftware.com/talks/wat"><strong>WAT?</strong></a></p>

<p><code>user</code> was never explicitly referenced in our test or a <code>before</code> block. Above I
also stated that the <code>let</code> closest to the test <em>wins</em>. Theoretically, by these
rules one would naturally think the test would have passed. Yet, someone was
created in the database.</p>

<p><em>Which user definition do you think was created?</em></p>

<p>If we dump the <code>User</code> collection before the <code>expect</code> line we see:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">[&lt;</span><span class="no">User</span> <span class="nb">id</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">&gt;</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Not only did the inner normal <code>let</code> block appear to override the outer, the
outer <code>let!</code> behavior took affect!</p>

<p>Let&#8217;s try one more:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">describe</span> <span class="s2">&quot;Using Conflicting Nested Let!&quot;</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">let!</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="n">create</span> <span class="ss">:user</span><span class="p">,</span> <span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;bob&#39;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="n">context</span> <span class="s2">&quot;inside a context&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="c1"># Now we&#39;ll use the bang version here</span>
</span><span class='line'>    <span class="n">let!</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="n">create</span> <span class="ss">:user</span><span class="p">,</span> <span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;alice&#39;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Will this pass?</span>
</span><span class='line'>    <span class="n">it</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">expect</span><span class="p">(</span><span class="no">User</span><span class="o">.</span><span class="n">count</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span> <span class="mi">1</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Surprise! It passes:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>Using Conflicting Nested Let!
</span><span class='line'>  inside a context
</span><span class='line'>    should eq 1
</span><span class='line'>
</span><span class='line'>Finished in 0.02185 seconds
</span><span class='line'>1 example, 0 failures
</span></code></pre></td></tr></table></div></figure>


<p>Again, dumping the user created we see our good friend Alice:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">[&lt;</span><span class="no">User</span> <span class="nb">id</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">&gt;</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you&#8217;re scratching your brain right now. Don&#8217;t worry. I did too the first
time.  However, once we cover what is happening behind that curtain things will
make perfect sense.</p>

<h2>How <code>let</code> and <code>let!</code> Work</h2>

<p>&#8220;<strong><em>Pay <del>[no]</del> attention</em></strong> to that man behind the curtain!&#8221;
- <a href="http://en.wikiquote.org/wiki/The_Wizard_of_Oz#The_Wizard">The Wizard</a></p>

<p>The reason for this behavior, remember I&#8217;m using RSpec 2.13, is that <code>let!</code>
just calls <code>let</code> and <code>before</code> <a href="https://github.com/rspec/rspec-core/blob/5baa615d/lib/rspec/core/memoized_helpers.rb#L257">behind the scenes</a>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">let!</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>  <span class="n">let</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>  <span class="n">before</span> <span class="p">{</span> <span class="nb">__send__</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>And all
<a href="https://github.com/rspec/rspec-core/blob/5baa615d/lib/rspec/core/memoized_helpers.rb#L195"><code>let</code></a>
does is setup a memoized method based on the name and provided block:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">MemoizedHelpers</span><span class="o">.</span><span class="n">module_for</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="ss">:define_method</span><span class="p">,</span> <span class="nb">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">define_method</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">__memoized</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">k</span><span class="o">|</span> <span class="n">__memoized</span><span class="o">[</span><span class="n">k</span><span class="o">]</span> <span class="o">=</span> <span class="k">super</span><span class="p">(</span><span class="o">&amp;</span><span class="kp">nil</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3><em>&#8220;Using Conflicting Let and Let!&#8221;</em> Explained</h3>

<p>Going back to the example <em>&#8220;Using Conflicting Let and Let!&#8221;</em> above, where both
<code>let!</code> and <code>let</code> were used. It should be a bit clearer what is really going on.</p>

<p>When the test runs, the <code>let!</code> has already created the <code>before</code> block, which
will send the message <code>:user</code>. However, the inner context&#8217;s <code>let</code> created a new
method with the same name. Thus based on standard Ruby method lookup, when the
<code>before</code> block runs the inner method receives the message:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">describe</span> <span class="s2">&quot;Using Conflicting Let and Let!&quot;</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Expanding the following out:</span>
</span><span class='line'>  <span class="c1"># let!(:user) { create :user, name: &#39;bob&#39; }</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">user</span>
</span><span class='line'>    <span class="n">create</span> <span class="ss">:user</span><span class="p">,</span> <span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;bob&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="n">before</span><span class="p">{</span> <span class="n">user</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">context</span> <span class="s2">&quot;inside a context&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="c1"># Expanding the following out:</span>
</span><span class='line'>    <span class="c1"># let(:user) { create :user, name: &#39;alice&#39; }</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">user</span>
</span><span class='line'>      <span class="n">create</span> <span class="ss">:user</span><span class="p">,</span> <span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;alice&#39;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># The outer `before` block will run before this example.</span>
</span><span class='line'>    <span class="c1"># Due to the examples being objects, the inner</span>
</span><span class='line'>    <span class="c1"># `def user` will receive the `:user` message sent</span>
</span><span class='line'>    <span class="c1"># by `before`.</span>
</span><span class='line'>    <span class="n">it</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">expect</span><span class="p">(</span><span class="no">User</span><span class="o">.</span><span class="n">count</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span> <span class="mi">0</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3><em>&#8220;Using Conflicting Nested Let!&#8221;</em> Explained</h3>

<p>It should also start to make sense what was going on with the <em>&#8220;Using
Conflicting Nested Let!&#8221;</em> example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">describe</span> <span class="s2">&quot;Using Conflicting Nested Let!&quot;</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Expanding the following out:</span>
</span><span class='line'>  <span class="c1"># let!(:user) { create :user, name: &#39;bob&#39; }</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">user</span>
</span><span class='line'>    <span class="n">create</span> <span class="ss">:user</span><span class="p">,</span> <span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;bob&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="n">before</span><span class="p">{</span> <span class="n">user</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">context</span> <span class="s2">&quot;inside a context&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="c1"># Now we&#39;ll use the bang version here</span>
</span><span class='line'>    <span class="c1"># Expanding the following out:</span>
</span><span class='line'>    <span class="c1"># let!(:user) { create :user, name: &#39;alice&#39; }</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">user</span>
</span><span class='line'>      <span class="n">create</span> <span class="ss">:user</span><span class="p">,</span> <span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;alice&#39;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">before</span><span class="p">{</span> <span class="n">user</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># The outer `before` block will run before this example.</span>
</span><span class='line'>    <span class="c1"># Due to the examples being objects, the inner</span>
</span><span class='line'>    <span class="c1"># `def user` will receive the `:user` message sent</span>
</span><span class='line'>    <span class="c1"># by the outer `before`.</span>
</span><span class='line'>    <span class="c1">#</span>
</span><span class='line'>    <span class="c1"># The inner `before` block will run next, also sending</span>
</span><span class='line'>    <span class="c1"># the message `:user`. This is also received by the</span>
</span><span class='line'>    <span class="c1"># inner example object. However, since `let` is also</span>
</span><span class='line'>    <span class="c1"># memoized, this doesn&#39;t actually execute the `:create`.</span>
</span><span class='line'>    <span class="c1"># It just returns the already created object.</span>
</span><span class='line'>    <span class="n">it</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">expect</span><span class="p">(</span><span class="no">User</span><span class="o">.</span><span class="n">count</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span> <span class="mi">1</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>It&#8217;s Just a Method</h3>

<p>I hope that helps demystify the behavior.</p>

<p>Since <code>let</code> is just a helper for setting up methods on the <a href="http://interblah.net/how-rspec-works">example group object</a>
you can call <code>super</code> in it; though this is generally not an advised practice.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">describe</span> <span class="s2">&quot;Just a Method&quot;</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">let!</span><span class="p">(</span><span class="ss">:sample</span><span class="p">)</span> <span class="p">{</span> <span class="s2">&quot;using let bang!&quot;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">context</span> <span class="s2">&quot;using super()&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">let</span><span class="p">(</span><span class="ss">:sample</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nb">p</span> <span class="k">super</span><span class="p">()</span>
</span><span class='line'>      <span class="s2">&quot;normal let&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">it</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span> <span class="s2">&quot;normal let&quot;</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>Just a Method
</span><span class='line'>  using super()
</span><span class='line'>&quot;using let bang!&quot;
</span><span class='line'>    should eq &quot;normal let&quot;
</span></code></pre></td></tr></table></div></figure>


<h2>Avoiding Ambiguity</h2>

<p>Since that tiny little <code>!</code> can be hard to see, especially in a sea of <code>let</code>
declarations, it is easy to miss it and get surprised. Additionally, seeing as
how mixing <code>let!</code> and <code>let</code> can lead to some surprises, it&#8217;s fairly clear why
<code>let!</code> has started, rightly so in my opinion, to fall out of favor with some of
the RSpec crowd.</p>

<p>Luckily, there should be very few situations you should find yourself in where
you want to reach for <code>let!</code> over <code>let</code>. For me, this is usually a situation
where I&#8217;m creating some sort of persisted resource. For instance, the factory
example, or creating a test file on the system.</p>

<h2>Options For Preloading</h2>

<p>If people are moving away from using <code>let!</code>, how should you preload variables?</p>

<h3>Reference in <code>before</code></h3>

<p>Call them just like RSpec does in a <code>before</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">let</span><span class="p">(</span><span class="ss">:bob</span><span class="p">)</span>   <span class="p">{</span> <span class="n">create</span> <span class="ss">:user</span><span class="p">,</span> <span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;bob&#39;</span>   <span class="p">}</span>
</span><span class='line'><span class="n">let</span><span class="p">(</span><span class="ss">:alice</span><span class="p">)</span> <span class="p">{</span> <span class="n">create</span> <span class="ss">:user</span><span class="p">,</span> <span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;alice&#39;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">before</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">bob</span>
</span><span class='line'>  <span class="n">alice</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>To me this looks a bit odd. People I&#8217;ve talked to tend to have two reactions:</p>

<ol>
<li>Why are you referencing a <em>&#8216;variable&#8217;</em> and not using it?</li>
<li>Wouldn&#8217;t it be a bit more explicit to show the creation using an <code>@var</code>?</li>
</ol>


<p>By now you should know that the first response indicates a lack of understand on
how RSpec works. They aren&#8217;t variables, they are actually bareword messages.</p>

<p>The second response is a valid point. The result would be:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">before</span> <span class="k">do</span>
</span><span class='line'>  <span class="vi">@bob</span>   <span class="o">=</span> <span class="n">create</span> <span class="ss">:user</span><span class="p">,</span> <span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;bob&#39;</span>
</span><span class='line'>  <span class="vi">@alice</span> <span class="o">=</span> <span class="n">create</span> <span class="ss">:user</span><span class="p">,</span> <span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;alice&#39;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This goes back to preference and style. My preference is to reach for a
bareword whenever I can. One reason is that, when using an instance variables
you are now locked in to how both <code>@bob</code> and <code>@alice</code> are created. If you later
wanted to modify them, you could but at the expense of already having created
the persisted resource; remember <code>before</code> blocks execute outside-in (this isn&#8217;t
so much of an issue for lightweight objects). Or you have to roll your own
memoization scheme (not hard just duplication of work).</p>

<h3>Use a method</h3>

<p>The next common thing I see done is people say: <em>&#8220;I&#8217;ll just wrap it all up in a
method.&#8221;</em></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">create_users</span>
</span><span class='line'>  <span class="vi">@bob</span>   <span class="o">=</span> <span class="n">create</span> <span class="ss">:user</span><span class="p">,</span> <span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;bob&#39;</span>
</span><span class='line'>  <span class="vi">@alice</span> <span class="o">=</span> <span class="n">create</span> <span class="ss">:user</span><span class="p">,</span> <span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;alice&#39;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">before</span> <span class="p">{</span> <span class="n">create_users</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now the <code>before</code> looks better; it&#8217;s explicit what is happening. However, the
new <code>create_users</code> method looks just like our old <code>before</code>. So this really just
added one level of indirection.  The main advantage here is if we need to
change the behavior we can just write a new <code>create_users</code> method in an inner
context. We could also use barewords by making our variables into methods:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">bob</span>
</span><span class='line'>  <span class="vi">@bob</span> <span class="o">||=</span> <span class="n">create</span> <span class="ss">:user</span><span class="p">,</span> <span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;bob&#39;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">alice</span>
</span><span class='line'>  <span class="vi">@alice</span> <span class="o">||=</span> <span class="n">create</span> <span class="ss">:user</span><span class="p">,</span> <span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;alice&#39;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">create_users</span>
</span><span class='line'>  <span class="n">bob</span>
</span><span class='line'>  <span class="n">alice</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">before</span> <span class="p">{</span> <span class="n">create_users</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Though now we&#8217;ve duplicated the lazy loading and memoizing logic already
provided by <code>let</code>.</p>

<p>At this point, you&#8217;ll probably say, we can make this a bit more explicit and
clean it up at the same time:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">bob</span>
</span><span class='line'>  <span class="vi">@bob</span> <span class="o">||=</span> <span class="n">create</span> <span class="ss">:user</span><span class="p">,</span> <span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;bob&#39;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">alice</span>
</span><span class='line'>  <span class="vi">@alice</span> <span class="o">||=</span> <span class="n">create</span> <span class="ss">:user</span><span class="p">,</span> <span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;alice&#39;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">create_users</span><span class="p">(</span><span class="o">*</span><span class="n">users</span><span class="p">)</span>
</span><span class='line'>  <span class="n">users</span><span class="o">.</span><span class="n">each</span><span class="p">{</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="n">public_send</span> <span class="n">user</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">before</span> <span class="p">{</span> <span class="n">create_users</span> <span class="ss">:bob</span><span class="p">,</span> <span class="ss">:alice</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This brings me to my next option.</p>

<h3>Explicit Preload</h3>

<p>Now there&#8217;s nothing inherently wrong with the above methods. However, to me
they add a lot of work, without adding much additional value. There are still
cases where I&#8217;ll break out the generator method as it&#8217;s a very useful tool. But
this section is about another option, so I&#8217;ll get to it.</p>

<p>Having gone through the cycle of improvement the <em>&#8220;hard&#8221;</em> way, it&#8217;s time to
show you the shortcut. To me, this is reminiscent of high school calculus
class where the teacher made me do everything the difficult, time consuming
way, for a week before teaching how it&#8217;s usually done with the shorter method.</p>

<p>Since pretty much everything in RSpec is already just a method, we can leverage
that to get our desired behavior. This was discussed in a <a href="https://github.com/rspec/rspec-core/pull/815#issuecomment-14446077">pull request</a>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">LetPreloadable</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">preload</span><span class="p">(</span><span class="o">*</span><span class="n">names</span><span class="p">)</span>
</span><span class='line'>    <span class="n">before</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">names</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="nb">name</span><span class="o">|</span> <span class="nb">__send__</span> <span class="nb">name</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">RSpec</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">rspec</span><span class="o">|</span>
</span><span class='line'>  <span class="n">rspec</span><span class="o">.</span><span class="n">extend</span> <span class="no">LetPreloadable</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>You can place the module code anywhere you want (usually in <code>spec/support</code>).
Then you&#8217;ll load it in a <code>RSpec.configure</code> block either in the same file or in
<code>spec_helper.rb</code>.</p>

<p>Our setup now looks like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">let</span><span class="p">(</span><span class="ss">:bob</span><span class="p">)</span>   <span class="p">{</span> <span class="n">create</span> <span class="ss">:user</span><span class="p">,</span> <span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;bob&#39;</span>   <span class="p">}</span>
</span><span class='line'><span class="n">let</span><span class="p">(</span><span class="ss">:alice</span><span class="p">)</span> <span class="p">{</span> <span class="n">create</span> <span class="ss">:user</span><span class="p">,</span> <span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;alice&#39;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">preload</span> <span class="ss">:bob</span><span class="p">,</span> <span class="ss">:alice</span>
</span></code></pre></td></tr></table></div></figure>


<p>Going back to our original example. There is now more context to what is
happening without the confusing mix of <code>let</code> and <code>let!</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">describe</span> <span class="s2">&quot;No More Conflicting Let and Let!&quot;</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="n">create</span> <span class="ss">:user</span><span class="p">,</span> <span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;bob&#39;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">preload</span> <span class="ss">:user</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">context</span> <span class="s2">&quot;inside a context&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="n">create</span> <span class="ss">:user</span><span class="p">,</span> <span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;alice&#39;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">it</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">expect</span><span class="p">(</span><span class="no">User</span><span class="o">.</span><span class="n">count</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span> <span class="mi">1</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Introducing <a href="https://github.com/cupakromer/conjurer"><code>Conjurer</code></a> Gem</h2>

<p>I&#8217;ve started using this in enough new projects that I wanted an easy way to
just add it. I also wanted to be able to include any changes easily. Thus, I&#8217;ve
rolled it all up into a gem: <a href="http://rubygems.org/gems/conjurer"><code>conjurer</code></a></p>

<p><strong>Happy RSpecing!!</strong></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Quirky Privates]]></title>
    <link href="http://cupakromer.github.com/blog/2013-01-07-quirky-privates.html"/>
    <updated>2013-01-07T20:35:00-05:00</updated>
    <id>http://cupakromer.github.com/blog/quirky-privates</id>
    <content type="html"><![CDATA[<p>Just one of those little Ruby language quirks. Normally, you have to use
the implicit receiver when sending a <code>private</code> message. This can be
demonstrated as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Quirky</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">send_private_explicitly</span>
</span><span class='line'>    <span class="nb">self</span><span class="o">.</span><span class="n">say_hello</span>    <span class="c1"># =&gt; NoMethodError: private method &#39;say_hello&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">send_private_implicitly</span>
</span><span class='line'>    <span class="n">say_hello</span>         <span class="c1"># =&gt; &quot;Hi there friend!&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">say_hello</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;Hi there friend!&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>However, this is not true when sending a message that ends in <code>=</code>. In
this case you <em>must</em> use the explicit receiver <code>self</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Quirky</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">send_private_setter_explicitly</span>
</span><span class='line'>    <span class="nb">self</span><span class="o">.</span><span class="n">store_value</span> <span class="o">=</span> <span class="s1">&#39;friend&#39;</span>     <span class="c1"># =&gt; @private_value=&#39;friend&#39;</span>
</span><span class='line'>    <span class="n">store_value</span>                     <span class="c1"># =&gt; &quot;Let&#39;s get our private value&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">send_private_setter_implicitly</span>
</span><span class='line'>    <span class="n">store_value</span> <span class="o">=</span> <span class="s1">&#39;friend&#39;</span>          <span class="c1"># =&gt; @private_value is not set</span>
</span><span class='line'>    <span class="n">store_value</span>                     <span class="c1"># =&gt; &#39;friend&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">store_value</span><span class="o">=</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@private_value</span> <span class="o">=</span> <span class="n">value</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">store_value</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;Let&#39;s get our private value&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>In fact, without the explicit reciever <code>self</code> when sending a private
message ending in <code>=</code>, you will instead create a local variable with
that name. This is then the reference point for the rest of the method
body.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[How Basic RSpec Works - Simplified]]></title>
    <link href="http://cupakromer.github.com/blog/2012-12-09-how-basic-rspec-works-simplified.html"/>
    <updated>2012-12-09T20:15:00-05:00</updated>
    <id>http://cupakromer.github.com/blog/how-basic-rspec-works-simplified</id>
    <content type="html"><![CDATA[<p>Recently, I had the privilege of giving a talk regarding
<a href="http://rspec.info">RSpec</a> at the
<a href="http://www.meetup.com/Arlington-Ruby/">Arlington Ruby</a> meetup group.
The talk was about RSpec and how you can take some next steps with it
(slides here: <a href="http://rspec-next-steps.herokuapp.com">http://rspec-next-steps.herokuapp.com</a>.</p>

<p>The talk was targeted at intermediate RSpec users. There were several in
attendance whom were fairly new to RSpec. This made some of the talk
seem like &#8220;magic&#8221;. Based on the questions I received, I wanted to take a
moment to address some of the general workings of RSpec, in order to
dispel any &#8220;magic&#8221; that may seem to be happening.</p>

<p>It is my hope to try to show how <em>some</em> of this works. I won&#8217;t be
covering any of the more advanced topics just yet, as the code can get a
bit complicated, and the point here is to simplify how RSpec works. So
bare with me and the overly simplistic implementation. The full code is
available in the following GitHub gist:
<a href="https://gist.github.com/4247624">https://gist.github.com/4247624</a></p>

<p>First, we need to setup some methods that define the basic usage of
RSpec: <code>describe</code>, <code>subject</code>, <code>before</code>, <code>after</code>, and <code>it</code>.</p>

<p>First up is the outer <code>describe</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">describe</span><span class="p">(</span><span class="n">object_under_test</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>  <span class="vi">@obj_under_test</span> <span class="o">=</span> <span class="n">object_under_test</span>
</span><span class='line'>  <span class="vi">@test_group</span>     <span class="o">=</span> <span class="n">block</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>In this example we are specifically only supporting a single <code>describe</code>
block with no nesting. The reason here is for simplicity.  In our case
<code>describe</code> is just a method that takes an object or description string
and block. Nothing special. Hopefully, this helps make it clear that we
are only dealing with a DSL for creating / setting up examples. We&#8217;ll
store away the test object in an instance variable and keep a reference
to the block for later.</p>

<p>Next, we setup a method for gaining access to subject:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">subject</span>
</span><span class='line'>  <span class="k">if</span> <span class="vi">@obj_under_test</span><span class="o">.</span><span class="n">is_a?</span> <span class="no">Class</span>
</span><span class='line'>    <span class="vi">@subject</span> <span class="o">||=</span> <span class="vi">@obj_under_test</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="vi">@obj_under_test</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>If our subject is a <code>class</code>, we create a new memoized instance of it.
Otherwise, we simply return the object itself.</p>

<p>Next is the commonly used <code>before</code> blocks and the associated <code>after</code>
friend:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">before</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span> <span class="vi">@before_hooks</span> <span class="o">&lt;&lt;</span> <span class="n">block</span> <span class="k">end</span>
</span><span class='line'><span class="k">def</span> <span class="nf">after</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>  <span class="vi">@after_hooks</span>  <span class="o">&lt;&lt;</span> <span class="n">block</span> <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>In this simplistic implementation, it is easy to see how they work. We
just keep a reference to all of the block in a normal array (in Ruby the
order of insertion is preserved) for use later. We do the same with
<code>after</code>.</p>

<p>Last up, is the real meat of the examples, the <code>it</code> block:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">it</span><span class="p">(</span><span class="n">description</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>  <span class="vi">@examples</span> <span class="o">&lt;&lt;</span> <span class="no">Example</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">description</span><span class="p">,</span> <span class="n">block</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">Example</span> <span class="o">=</span> <span class="no">Struct</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:description</span><span class="p">,</span> <span class="ss">:test</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>  <span class="kp">attr_accessor</span> <span class="ss">:result</span><span class="p">,</span> <span class="ss">:failure</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">call</span>
</span><span class='line'>    <span class="vi">@result</span> <span class="o">=</span> <span class="k">if</span> <span class="nb">test</span>
</span><span class='line'>                <span class="k">begin</span>
</span><span class='line'>                  <span class="nb">test</span><span class="o">.</span><span class="n">call</span>
</span><span class='line'>                  <span class="ss">:passed</span>
</span><span class='line'>                <span class="k">rescue</span> <span class="o">=&gt;</span> <span class="n">e</span>
</span><span class='line'>                  <span class="vi">@failure</span> <span class="o">=</span> <span class="n">e</span>
</span><span class='line'>                  <span class="ss">:failed</span>
</span><span class='line'>                <span class="k">end</span>
</span><span class='line'>              <span class="k">else</span>
</span><span class='line'>                <span class="ss">:pending</span>
</span><span class='line'>              <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>As with the <code>describe</code> method, this takes an optional description and a
block to execute (our actual test). We&#8217;ll need access to both of these
later, and we&#8217;ll have multiple examples, so we&#8217;ll use a simple object to
keep track of each.  After creating the example object, we&#8217;ll store it
in the queue.</p>

<p>At this point it is worth taking a moment to discuss <code>Example#call</code>. We
named it <code>call</code> so that accessing it is no different than a traditional
block. This makes it easier to change code later.</p>

<p>Inside <code>Example#call</code>, we attempt to pass <code>call</code> on the block that the
<code>Example</code> was created with. If this raises an error, we store the
exception for access later and mark the test as <code>failed</code>. Something to
note here is that the return value of the <code>test</code> block is ignored. A
test is marked as <code>passed</code> as long as it does not <code>raise</code> any errors.
This is also how RSpec behaves.</p>

<p>If no block was given when we created the <code>Example</code>, then we treat it as
<code>pending</code>.  I have omitted the <code>pending</code> method, common in RSpec due to
the complexity it would add to this example.</p>

<p>Something else to note, since this is an overly simplistic example, we
are doing everything in the global main namespace. RSpec does <em>not</em>
behave this way, but it helps keep our example simple. Due to this,
we&#8217;ll need to setup some of our variables:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="vi">@before_hooks</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'><span class="vi">@after_hooks</span>  <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'><span class="vi">@examples</span>     <span class="o">=</span> <span class="o">[]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Additionally, we don&#8217;t have any matchers defined yet. To keep it simple,
I&#8217;ll add a TestUnit style <code>assert</code> matcher.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">assert</span><span class="p">(</span><span class="n">truthy</span><span class="p">)</span>
</span><span class='line'>  <span class="n">truthy</span> <span class="ow">or</span> <span class="k">raise</span> <span class="no">Error</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;Test failed.&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>At this point, I hope you can start to get the picture of how our
simplified example will run.  We&#8217;ll setup our <code>run</code> as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">run</span>
</span><span class='line'>  <span class="k">raise</span> <span class="s1">&#39;No object under test defined.&#39;</span> <span class="k">unless</span> <span class="vi">@obj_under_test</span>
</span><span class='line'>
</span><span class='line'>  <span class="nb">puts</span> <span class="vi">@obj_under_test</span>
</span><span class='line'>  <span class="k">return</span> <span class="k">unless</span> <span class="vi">@test_group</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Find out what tests need to be run</span>
</span><span class='line'>  <span class="vi">@test_group</span><span class="o">.</span><span class="n">call</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Run the tests</span>
</span><span class='line'>  <span class="vi">@examples</span><span class="o">.</span><span class="n">each_with_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">example</span><span class="p">,</span> <span class="n">index</span><span class="o">|</span>
</span><span class='line'>    <span class="vi">@subject</span> <span class="o">=</span> <span class="kp">nil</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">EXAMPLE </span><span class="si">#{</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">:&quot;</span>
</span><span class='line'>    <span class="k">begin</span>
</span><span class='line'>      <span class="vi">@before_hooks</span><span class="o">.</span><span class="n">each</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:call</span><span class="p">)</span>
</span><span class='line'>      <span class="n">example</span><span class="o">.</span><span class="n">call</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    </span><span class="si">#{</span><span class="n">example</span><span class="o">.</span><span class="n">description</span><span class="si">}</span><span class="s2"> =&gt; </span><span class="si">#{</span><span class="n">example</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">upcase</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="k">rescue</span> <span class="o">=&gt;</span> <span class="n">e</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    </span><span class="si">#{</span><span class="n">example</span><span class="o">.</span><span class="n">description</span><span class="si">}</span><span class="s2"> =&gt; failed</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="k">ensure</span>
</span><span class='line'>      <span class="vi">@after_hooks</span><span class="o">.</span><span class="n">reverse_each</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:call</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>If there is no object under test defined when we <code>run</code> (i.e. <code>describe</code>
was never called) then we raise an error. Otherwise, we output the
object under test. If this is a <code>class</code> (as is usual for a top level
<code>describe</code> block) then we will see the class name. Otherwise, the object
itself is output.  If it is a string, we&#8217;ll get the string value,
otherwise, we&#8217;ll get the object&#8217;s <code>#to_s</code> representation.</p>

<p><em>It should be noted that in the real RSpec this outputting is much more
complicated and left up to various output formatters.</em></p>

<p>Next we will run the <code>test_group</code> (the body of the <code>describe</code> block). This
in turn call all our <code>before</code>, <code>after</code>, and <code>it</code> methods, which set up our
environment and define the examples.</p>

<p>All that is left, is to iterate over the examples and run them. Here I&#8217;m
using <code>each_with_index</code> solely to be able to add some debugging output
to make it a bit clearer how things are running. Normally, this would be
a simple <code>each</code> iterator.</p>

<p>Before each test run, we make sure we have a new empty <code>subject</code>. We
then iterate through each of the <code>before</code> blocks in the order they were
defined. At this point we run the example. After the example runs, I&#8217;m
immediately
outputting the results to keep things simple. In the real RSpec, this is
handled by an output formatter. Finally, all of the <code>after</code> hooks are
run, but in reverse defined order.</p>

<p>It should be noted, that here, as in the real RSpec, if any of the
<code>before</code> blocks throw an exception the test fails. However, failures in
any <code>after</code> block are ignored.</p>

<p>That&#8217;s it. We can then use this to define our sample spec:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Thing</span>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:my_value</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span>
</span><span class='line'>    <span class="vi">@my_value</span> <span class="o">=</span> <span class="nb">rand</span> <span class="mi">5</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">describe</span> <span class="no">Thing</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">before</span> <span class="p">{</span> <span class="nb">puts</span> <span class="s2">&quot;BEFORE_BLOCK:: First before block&quot;</span> <span class="p">}</span>
</span><span class='line'>  <span class="n">after</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">print</span> <span class="s2">&quot;AFTER_BLOCK:: should be called last!&quot;</span>
</span><span class='line'>    <span class="nb">print</span> <span class="s2">&quot;    Reset @tmp_value(</span><span class="si">#{</span><span class="vi">@tmp_value</span><span class="o">.</span><span class="n">inspect</span><span class="si">}</span><span class="s2">) =&gt; &quot;</span>
</span><span class='line'>    <span class="vi">@tmp_value</span> <span class="o">=</span> <span class="kp">nil</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;@tmp_value(</span><span class="si">#{</span><span class="vi">@tmp_value</span><span class="o">.</span><span class="n">inspect</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">it</span> <span class="s1">&#39;has access to subject&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">p</span> <span class="n">subject</span>
</span><span class='line'>    <span class="n">assert</span> <span class="n">subject</span><span class="o">.</span><span class="n">my_value</span> <span class="o">&lt;</span> <span class="mi">5</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">it</span> <span class="s1">&#39;subject changes only between tests&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">p</span> <span class="n">subject</span>
</span><span class='line'>    <span class="n">assert</span> <span class="n">subject</span><span class="o">.</span><span class="n">equal?</span><span class="p">(</span><span class="n">subject</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">it</span> <span class="s2">&quot;fails on error&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="k">raise</span> <span class="no">Error</span><span class="o">.</span><span class="n">new</span> <span class="s1">&#39;Sad face&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">it</span> <span class="s1">&#39;works!&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">assert</span> <span class="vi">@tmp_value</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">before</span> <span class="k">do</span>
</span><span class='line'>    <span class="vi">@tmp_value</span> <span class="o">=</span> <span class="s1">&#39;test&#39;</span>
</span><span class='line'>    <span class="nb">print</span> <span class="s2">&quot;BEFORE_BLOCK:: Another before block&quot;</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;     Set @tmp_value(</span><span class="si">#{</span><span class="vi">@tmp_value</span><span class="o">.</span><span class="n">inspect</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">it</span> <span class="s1">&#39;is pending&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">after</span> <span class="p">{</span> <span class="nb">puts</span> <span class="s2">&quot;AFTER_BLOCK:: should be called first!!&quot;</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>I hope it is clear how this spec will end up running. This is not
exactly equivalent to how RSpec will treat things (notice that we need
to explicitly clear <code>@tmp_value</code> in an <code>after</code> block, where RSpec will
do that for us). This is due to how RSpec creates example classses
(which we are not using) and how it binds the blocks to different
scopes; we are strictly using the <code>global</code> namespace to keep the example
simple.</p>

<p>Check out the gist for the code and output of the sample spec:
<a href="http://gist.github.com/4247624">http://gist.github.com/4247624</a></p>

<p>Stay tuned for more on RSpec in the future.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[=== the Forgotten Equality]]></title>
    <link href="http://cupakromer.github.com/blog/2012-10-12-equals-equals-equals-the-forgotten-equality.html"/>
    <updated>2012-10-12T19:04:00-04:00</updated>
    <id>http://cupakromer.github.com/blog/equals-equals-equals-the-forgotten-equality</id>
    <content type="html"><![CDATA[<p>Recently I was looking for a way to do a comparison on a <code>String</code> with
either another <code>String</code> or a <code>Regexp</code>. Most of the discussions on equality
focused on <code>==</code>, <code>eql?</code>, <code>equal?</code>. None of which would satisfy the requirement.
So I was left with this code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">matches</span><span class="p">(</span><span class="n">compare_with</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">compare_with</span><span class="o">.</span><span class="n">is_a?</span><span class="p">(</span><span class="no">Regexp</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@data_string</span> <span class="o">=~</span> <span class="n">compare_with</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="vi">@data_string</span> <span class="o">==</span> <span class="n">compare_with</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>I was less than thrilled. So I did what everyone does, I asked the internet.
Thanks to Twitter, specifically James Edward Gray II
<a href="https://twitter.com/jeg2">@JEG2</a> who btw completely rocks, I was pointed at
<code>===</code>. Though the documentation on <code>===</code> leaves something to be desired:</p>

<p>  <blockquote><p>Used to compare each of the items with the target in the <code>when</code> clause of<br/>  a <code>case</code> statement.</p><footer><strong>Dave Thomas, Programming Ruby 1.9, page 128</strong> <cite><a href='http://pragprog.com/book/ruby/programming-ruby'>pragprog.com/book/ruby/&hellip;</a></cite></footer></blockquote></p>

<ul>
<li>The <a href="http://ruby-doc.org/core-1.9.3/String.html#method-i-3D-3D-3D">String API</a>
sneakily directs you to <code>==</code> but doesn&#8217;t outright state they are the same</li>
<li>The <a href="http://ruby-doc.org/core-1.9.3/Regexp.html#method-i-3D-3D-3D">Regexp API</a>
states it as a synonym for <a href="http://ruby-doc.org/core-1.9.3/Regexp.html#method-i-3D-7E"><code>Regexp#=~</code></a></li>
</ul>


<p>The thing to remember is with <code>case</code> when you have the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">case</span> <span class="n">thing</span>
</span><span class='line'><span class="k">when</span> <span class="n">other_thing</span>
</span><span class='line'>  <span class="c1"># stuff</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>You are just saying <code>other_thing === thing</code>. The comparison is performed with
the <code>when</code> expression as the lvalue.</p>

<p>This means I could rewrite the <code>matches</code> method as:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">matches</span><span class="p">(</span><span class="n">compare_with</span><span class="p">)</span>
</span><span class='line'>  <span class="n">compare_with</span> <span class="o">===</span> <span class="vi">@data_string</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This also means it&#8217;s possible to be more flexible on the match:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># @data_string = &quot;coding for fun&quot;</span>
</span><span class='line'><span class="n">matches</span> <span class="s2">&quot;oding&quot;</span>           <span class="c1"># false</span>
</span><span class='line'><span class="n">matches</span> <span class="s2">&quot;coding for fun&quot;</span>  <span class="c1"># true</span>
</span><span class='line'><span class="n">matches</span> <span class="sr">/oding/</span>           <span class="c1"># true</span>
</span><span class='line'><span class="n">matches</span> <span class="nb">String</span>            <span class="c1"># true</span>
</span></code></pre></td></tr></table></div></figure>


<p>So, the next time you&#8217;re thinking of writing some code that needs to
change based on class type or how something compares with something else, think
if a <code>case</code> statement applies. If it does, see if <code>===</code> works to produce better
code.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Everyone Should Learn metaprogramming]]></title>
    <link href="http://cupakromer.github.com/blog/2012-08-14-everyone-should-learn-meta-programming.html"/>
    <updated>2012-08-14T17:54:00-04:00</updated>
    <id>http://cupakromer.github.com/blog/everyone-should-learn-meta-programming</id>
    <content type="html"><![CDATA[<p>A few weeks ago was the first <a href="http://steelcityrubyconf.org/">Steel City Ruby conference</a>.
It was a great conference and I would highly recommend you attend next
year. While there, I had the opportunity to give my first lightning talk.</p>

<p><a href="http://www.flickr.com/photos/charliekilo/7717397572/in/photostream"><img class="right" src="http://cupakromer.github.com/images/scrc12_lightning_talk.jpg" width="391" height="287" title="12 Lightning Talk" alt="An image of me presenting at SCRC12"></a>
Now I&#8217;m not one for public speaking, in fact it&#8217;s terrifying for me.
However, the Ruby community is awesome, friendly, and very encouraging.
After thinking about it for a while, talking with several people, and
reflecting on my time participating in <a href="http://scrappyacademy.com/">Scrappy Academy</a>,
I decided that it was important to speak up about metaprogramming.</p>

<p>I titled my talk: &#8221;<em>Demystifying Metaprogramming</em>.&#8221; The intent was to
encourage those people who are afraid of &#8220;metaprogramming&#8221; to give it a
try. I strongly believe if you have been programming Ruby (or Rails -
this is just Ruby with a fun web framework) for more than two months,
you owe it to yourself to learn metaprogramming.</p>

<p>To most people, this included me, they hear about &#8220;metaprogramming&#8221; as
this advanced technique that should be avoided by all but the most
wizardly among us. Frankly, this big scary stigma attached to
metaprogramming just isn&#8217;t warranted.</p>

<p><span class='pullquote-right' data-pullquote='&#8220;metaprogramming&#8221; is just
programming'>
I&#8217;ll let you in on the big secret, &#8220;metaprogramming&#8221; is just
programming. Yep. It&#8217;s not scary. It may be a bit complicated, but at
the end of the day it is well worth your time to learn. You may even find
it to be fun.
</span></p>

<p>To help ease you into the topic, we&#8217;ll start with a simple contrived
example to demonstrate that you already know everything needed to get
started.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">say</span><span class="p">(</span> <span class="n">phrase</span> <span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="n">phrase</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Yep. That&#8217;s a really basic method. It simply <code>puts</code> the object that is
passed in. To use this method in <a href="http://en.wikipedia.org/wiki/Interactive_Ruby_Shell">irb</a>
or <a href="https://github.com/pry/pry">pry</a> we could simply:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&gt;</span> <span class="k">def</span> <span class="nf">say</span><span class="p">(</span> <span class="n">phrase</span> <span class="p">)</span>
</span><span class='line'><span class="o">*</span>  <span class="nb">puts</span> <span class="n">phrase</span>
</span><span class='line'><span class="o">*</span> <span class="k">end</span>
</span><span class='line'><span class="o">=&gt;</span> <span class="kp">nil</span>
</span><span class='line'><span class="o">&gt;</span> <span class="n">say</span> <span class="s2">&quot;Steel City Ruby I heard you like programming.&quot;</span>
</span><span class='line'><span class="no">Steel</span> <span class="no">City</span> <span class="no">Ruby</span> <span class="n">I</span> <span class="n">heard</span> <span class="n">you</span> <span class="n">like</span> <span class="n">programming</span><span class="o">.</span>
</span><span class='line'><span class="o">=&gt;</span> <span class="kp">nil</span>
</span></code></pre></td></tr></table></div></figure>


<p>This shouldn&#8217;t be anything shocking so far. In fact, all we&#8217;ve done is
create a method that calls a method (<code>puts</code>) and pass it a parameter. In
fact, this concept is at the heart of the &#8220;meta&#8221; programming.</p>

<p>All you really are doing is writing methods, that call another method,
and pass it a parameter. It just so happens that the parameter you pass,
tends to be a block that defines a new method.</p>

<blockquote><p>Write a method, that calls a method, that creates a method.*</p></blockquote>


<p>So to extend our example and add the &#8220;meta&#8221; part to it, we&#8217;ll just:</p>

<ul>
<li>Wrap our method in another method</li>
<li>Pass our method as the parameter to another method</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">just_programming</span>
</span><span class='line'>  <span class="nb">class_eval</span> <span class="k">do</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">say</span><span class="p">(</span> <span class="n">phrase</span> <span class="p">)</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="n">phrase</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>In this case, we&#8217;re using the special <a href="http://www.ruby-doc.org/core-1.9.3/Module.html#method-i-class_eval"><code>class_eval</code></a>
method. In a nutshell, this will change the value of <code>self</code> and then
execute the block in this context. In our case, we provide it a block
which contains the method definition we wish to dynmically create. The
trick here is that class definitions and methods are active code. So the
call to <code>def say( phrase )</code> is run just as if we had typed it directly
in the original class definition.</p>

<p>To be able to use this in a context more familiar, we&#8217;ll just wrap this
in a module. We can then <code>extend</code> that module in our class and
dynamically create our method by using our class method
<code>just_programming</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Meta</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">just_programming</span>
</span><span class='line'>    <span class="nb">class_eval</span> <span class="k">do</span>
</span><span class='line'>      <span class="k">def</span> <span class="nf">say</span><span class="p">(</span> <span class="n">phrase</span> <span class="p">)</span>
</span><span class='line'>        <span class="nb">puts</span> <span class="n">phrase</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Foo</span>
</span><span class='line'>  <span class="kp">extend</span> <span class="no">Meta</span>
</span><span class='line'>  <span class="n">just_programming</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">f</span> <span class="o">=</span> <span class="no">Foo</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'><span class="n">f</span><span class="o">.</span><span class="n">say</span> <span class="s2">&quot;Steel City Ruby I heard you like programming.&quot;</span>
</span><span class='line'><span class="o">=&gt;</span> <span class="s2">&quot;Steel City Ruby I heard you like programming.&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>I hope this has helped illustrate that &#8220;metaprogramming&#8221; is only
programming. It isn&#8217;t anything to be afraid of. Sure, it can get
complicated at times, but then, what code concepts beyond the bare
basics can&#8217;t?</p>

<p>You owe it to yourself to learn these nifty and fun coding techniques.
They will demystify manly things you think are &#8220;magic&#8221;, provide a
deeper understanding of the Ruby language, and add tools to your
belt enabling you to write better code.</p>

<p>There are many resources on these topics if you do a search.
Additionally, <a href="http://pragprog.com/">The Pragmatic Bookshelf</a> has a
good set of resources on Ruby and metaprogramming. I found the
videos series on <a href="http://pragprog.com/screencasts/v-dtrubyom/the-ruby-object-model-and-metaprogramming">The Ruby Object Model and Metaprogramming</a>
very enlightening.</p>

<p>Happy programming!</p>

<p>* Technically, this should really be &#8220;Write a method, that <em>sends a
message</em>, that creates a method.&#8221; However, I wanted to emphasise the
progression and went with this version.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Travis CI Setup for Plain Old Ruby]]></title>
    <link href="http://cupakromer.github.com/blog/2012-07-18-travis-ci-setup-for-plain-old-ruby.html"/>
    <updated>2012-07-18T01:11:00-04:00</updated>
    <id>http://cupakromer.github.com/blog/travis-ci-setup-for-plain-old-ruby</id>
    <content type="html"><![CDATA[<p>I recently wanted to setup some automated testing for a mini project I
was working on. I was using regular Ruby and wanted to try working with
<a href="http://travis-ci.org/">Travis CI</a>. For public projects, this is a great <em>free</em>
resource which I cannot recommend enough.</p>

<p>They have a decent amount of <a href="http://about.travis-ci.org/docs/">documentation</a>
on how to setup your project. However, it took me longer than I thought
necessary to get a basic Ruby project configured.</p>

<p>In the end, it came down to needing three things:</p>

<ul>
<li><p>The <code>rake</code> gem present in either a <code>Gemfile</code> or <code>*.gemspec</code> file</p></li>
<li><p>A <code>.travis.yml</code> file</p></li>
</ul>


<figure class='code'><figcaption><span>.travis.yml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">language</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ruby</span>
</span><span class='line'><span class="l-Scalar-Plain">rvm</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">1.9.2</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">1.9.3</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>A <code>Rakefile</code> with a default task to run the tests</li>
</ul>


<figure class='code'><figcaption><span>Rakefile</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#!/usr/bin/env rake</span>
</span><span class='line'><span class="nb">require</span> <span class="s2">&quot;bundler/gem_tasks&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;rspec/core/rake_task&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">desc</span> <span class="s1">&#39;Default: Run specs.&#39;</span>
</span><span class='line'><span class="n">task</span> <span class="ss">default</span><span class="p">:</span> <span class="ss">:spec</span>
</span><span class='line'>
</span><span class='line'><span class="n">desc</span> <span class="s1">&#39;Run specs&#39;</span>
</span><span class='line'><span class="ss">RSpec</span><span class="p">:</span><span class="ss">:Core</span><span class="o">::</span><span class="no">RakeTask</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span> <span class="o">|</span><span class="n">task</span><span class="o">|</span>
</span><span class='line'>  <span class="n">task</span><span class="o">.</span><span class="n">rspec_opts</span> <span class="o">=</span> <span class="s2">&quot;--format doc&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Just drop those two files into your project directory and you are ready
to experience the fun of CI.</p>
]]></content>
  </entry>
  
</feed>
