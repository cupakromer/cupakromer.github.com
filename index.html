
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>Aaron Kromer's Blog</title>
    <meta name="author" content="Aaron Kromer">
    
	<meta name="description" content="Published on: Sep 29th, 2014 Tags: json, rspec, ruby In the past, testing JSON APIs tended to be a bit painful for me. Most of this
pain revolved &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="Aaron Kromer's Blog" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.ico" rel="shortcut icon">
    <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">

    <link href='http://fonts.googleapis.com/css?family=Slackey' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Amethysta' rel='stylesheet' type='text/css'>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
    <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

    <script type="text/javascript" src="/javascripts/jquery-tapir.js"></script>

    <!-- remove or comment it to disable ajaxification -->   
    <script src="/javascripts/ajaxify.js"></script>
   
    
    
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-34364108-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>


</head>


<body>
    <div id="wrapper">
    <header id="header" class="inner"><!-- for more effects see _animate.scss -->
<hgroup id="headerbg">
  <h1><a href="/">Aaron Kromer's Blog</a></h1>
  
    <h2>A little cup'a Kromer with your code</h2>
  
</hgroup>

<ul id="social-links">
  
  <!-- GitHub -->
  <li>
    <a href="https://github.com/cupakromer" title="GitHub">
      <i class="foundicon-github"></i>
    </a>
  </li>
  
  
  
  
  <!-- Twitter -->
  <li>
    <a href="http://www.twitter.com/cupakromer" title="Twitter">
      <i class="foundicon-twitter"></i>
    </a>
  </li>
  
  
  
  
  <li>
    <a href="/atom.xml">
      <i class="foundicon-rss"></i>
    </a>
  </li>
</ul>


<!-- use full url including 'index.html' for navigation bar if you are using ajax -->
<ul id="nav">
  <li id="ajax"><a href="/index.html">Home</a></li>
  <li id="ajax"><a href="/blog/archives/index.html">Archives</a></li>
  
  <li>
    <div id="dark">
      <form method="get" action="/search.html" id="search">
        <input name="query" type="text" placeholder="Search..." x-webkit-speech />
      </form>
    </div>
  </li>
  
</ul>




</header>

<div id="toload">
<!-- begin toload --> 
    <div id="content" class="inner">
        


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014-09-29-farewell-json-api-gems.html">
		
			Farewell JSON API Gems</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2014-09-29T11:51:00-04:00" pubdate data-updated="true">Sep 29<span>th</span>, 2014</time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/json/'>json</a>, <a class='category' href='/blog/categories/rspec/'>rspec</a>, <a class='category' href='/blog/categories/ruby/'>ruby</a>


</div>
    </div>
		<p>In the past, testing JSON APIs tended to be a bit painful for me. Most of this
pain revolved around setting expectations on the response body.</p>

<p>If you treat the response as a raw string, attempting to use regular
expressions ends up being an exercise in how you handle frustration. While a
JSON body is a string, it has structure. Using regular expressions for parsing
them is akin to using a hammer on a screw. It&#8217;ll get the job done, but it&#8217;s the
wrong tool for the job.</p>

<p>Ruby gives us <a href="http://ruby-doc.org/stdlib-2.1.3/libdoc/json/rdoc/JSON.html#method-i-parse"><code>JSON.parse</code></a>.
Which will convert a valid JSON string into a more familiar object structure.
Now comes the &#8220;fun&#8221; part of actually verifying that structure:</p>

<ul>
<li>Sometimes you only care about part of the response</li>
<li>Sometimes you care about validating the entire response</li>
<li>Sometimes the response is very complicated consisting of many smaller, more
logically meaningful, structures</li>
<li>Sometimes you only care about the general structure (e.g. this value must be
a number, that value must be either an empty array or an array of strings,
etc.)</li>
</ul>


<p>It is possible to do all of these validations out of the box. In my experience,
writing them tended to be tedious. Often the resulting code left something to
be desired in terms of readability. This was especially true when validating the
general response structure.</p>

<p>I like to follow the &#8220;one expectation per spec&#8221; guideline. However, this lead
to writing many small specs. Normally, this is perfectly fine and something I
advocate you do. However, in terms of a JSON response, it means I need to have
more discipline to keep everything explicitly organized.</p>

<p>Naturally in the Ruby community, many gems have sprouted up to help with this
problem set. I&#8217;ve had a bit of success with some of those gems in the past.
However, with the release of RSpec 3, <a href="http://myronmars.to/n/dev-blog/2014/01/new-in-rspec-3-composable-matchers">several new
features</a>
have eliminated my need for these JSON gems.</p>

<p>Expectations on a JSON response is a great fit for <a href="https://www.relishapp.com/rspec/rspec-expectations/v/3-0/docs/composing-matchers">composing
matchers</a>.
When I need to logically group checking several options, the <a href="https://www.relishapp.com/rspec/rspec-expectations/v/3-0/docs/compound-expectations">compound matchers</a>
are the perfect tool.</p>

<p>Often people don&#8217;t realize that the matcher messages (i.e. <code>exist</code>, <code>be</code>, <code>eq</code>,
<code>include</code>, etc) are just <del>factories</del> helpers (<a href="#json-factory-helper1">see
endnotes</a>). They are just helper methods which create
the matcher object for you. That means, we can easily write our own using our
app&#8217;s domain language.</p>

<p>Let&#8217;s jump right into an example!</p>

<p>These examples are assuming a JSON structure like one of the ones listed on the
<a href="http://jsonapi.org/format/#document-structure-compound-documents">jsonapi.org</a>
site. Though I am assuming integer value are represented as numbers and not
strings, since that is valid JSON and more meaningful:</p>

<figure class='code'><figcaption><span>&#8216;spec/requests/api/kits_spec.rb&#8217;</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;rails_helper&#39;</span>
</span><span class='line'><span class="c1"># Use common JSON helpers such as: `json_response`, `be_an_empty`, `all_match`</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;support/json_api_helpers&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="no">RSpec</span><span class="o">.</span><span class="n">describe</span> <span class="s2">&quot;/api/kits&quot;</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="ss">:request</span> <span class="k">do</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">be_kits_root_json</span>
</span><span class='line'>    <span class="n">be_kits_json</span><span class="o">.</span><span class="n">and</span><span class="p">(</span>
</span><span class='line'>      <span class="kp">include</span><span class="p">(</span>
</span><span class='line'>        <span class="s1">&#39;meta&#39;</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>          <span class="s1">&#39;first&#39;</span>   <span class="o">=&gt;</span> <span class="n">anything</span><span class="p">,</span>
</span><span class='line'>          <span class="s1">&#39;last&#39;</span>    <span class="o">=&gt;</span> <span class="n">anything</span><span class="p">,</span>
</span><span class='line'>          <span class="s1">&#39;current&#39;</span> <span class="o">=&gt;</span> <span class="n">anything</span><span class="p">,</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>      <span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">be_kits_json</span>
</span><span class='line'>    <span class="kp">include</span><span class="p">(</span>
</span><span class='line'>      <span class="s1">&#39;version&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;1.0&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="s1">&#39;links&#39;</span>   <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="s1">&#39;kits.beacons&#39;</span>       <span class="o">=&gt;</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">beacons_url</span><span class="si">}</span><span class="s2">/{kits.beacons}&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;kits.overlays&#39;</span>      <span class="o">=&gt;</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">overlays_url</span><span class="si">}</span><span class="s2">/{kits.overlays}&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;beacons.attributes&#39;</span> <span class="o">=&gt;</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">beacon_attributes_url</span><span class="si">}</span><span class="s2">/{beacons.attributes}&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>      <span class="s1">&#39;kits&#39;</span>    <span class="o">=&gt;</span> <span class="n">be_an_empty</span><span class="p">(</span><span class="nb">Array</span><span class="p">)</span><span class="o">.</span><span class="n">or</span><span class="p">(</span>
</span><span class='line'>        <span class="n">all_match</span><span class="p">(</span>
</span><span class='line'>          <span class="s1">&#39;id&#39;</span>        <span class="o">=&gt;</span> <span class="no">Fixnum</span><span class="p">,</span>
</span><span class='line'>          <span class="s1">&#39;name&#39;</span>      <span class="o">=&gt;</span> <span class="n">be_nil</span><span class="o">.</span><span class="n">or</span><span class="p">(</span><span class="n">be_a</span> <span class="nb">String</span><span class="p">),</span>
</span><span class='line'>          <span class="s1">&#39;api_token&#39;</span> <span class="o">=&gt;</span> <span class="nb">String</span><span class="p">,</span>
</span><span class='line'>          <span class="s1">&#39;account&#39;</span>   <span class="o">=&gt;</span> <span class="n">be_nil</span><span class="o">.</span><span class="n">or</span><span class="p">(</span>
</span><span class='line'>            <span class="n">match</span><span class="p">(</span>
</span><span class='line'>              <span class="s1">&#39;id&#39;</span>   <span class="o">=&gt;</span> <span class="no">Fixnum</span><span class="p">,</span>
</span><span class='line'>              <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="n">be_nil</span><span class="o">.</span><span class="n">or</span><span class="p">(</span><span class="n">be_a</span> <span class="nb">String</span><span class="p">),</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>          <span class="p">),</span>
</span><span class='line'>          <span class="s1">&#39;links&#39;</span>     <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>            <span class="s1">&#39;self&#39;</span>     <span class="o">=&gt;</span> <span class="sr">/\A</span><span class="si">#{</span><span class="n">kits_url</span><span class="si">}</span><span class="sr">\/\d+\z/</span><span class="p">,</span>
</span><span class='line'>            <span class="s1">&#39;beacons&#39;</span>  <span class="o">=&gt;</span> <span class="n">be_an_empty</span><span class="p">(</span><span class="nb">Array</span><span class="p">)</span><span class="o">.</span><span class="n">or</span><span class="p">(</span><span class="n">all</span> <span class="n">be_a</span> <span class="no">Fixnum</span><span class="p">),</span>
</span><span class='line'>            <span class="s1">&#39;overlays&#39;</span> <span class="o">=&gt;</span> <span class="n">be_an_empty</span><span class="p">(</span><span class="nb">Array</span><span class="p">)</span><span class="o">.</span><span class="n">or</span><span class="p">(</span><span class="n">all</span> <span class="n">be_a</span> <span class="no">Fixnum</span><span class="p">),</span>
</span><span class='line'>          <span class="p">},</span>
</span><span class='line'>        <span class="p">),</span>
</span><span class='line'>      <span class="p">),</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">include_linked_resources</span><span class="p">(</span><span class="o">*</span><span class="n">resources</span><span class="p">)</span>
</span><span class='line'>    <span class="n">resource_maps</span> <span class="o">=</span> <span class="n">resources</span><span class="o">.</span><span class="n">each_with_object</span><span class="p">({})</span> <span class="p">{</span> <span class="o">|</span><span class="n">resource</span><span class="p">,</span> <span class="n">mappings</span><span class="o">|</span>
</span><span class='line'>      <span class="n">mappings</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">to_s</span><span class="p">,</span> <span class="n">be_an</span><span class="p">(</span><span class="nb">Array</span><span class="p">))</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="kp">include</span><span class="p">(</span><span class="s1">&#39;linked&#39;</span> <span class="o">=&gt;</span> <span class="n">resource_maps</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">context</span> <span class="s2">&quot;a basic user&quot;</span><span class="p">,</span> <span class="s2">&quot;with a kit having no beacons or maps&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="c1"># Setup world state</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">describe</span> <span class="s2">&quot;requesting the kits root&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">it</span> <span class="s2">&quot;conforms to the expected JSON structure&quot;</span> <span class="k">do</span>
</span><span class='line'>        <span class="n">get</span> <span class="n">kits_path</span><span class="p">,</span> <span class="o">*</span><span class="n">options</span>
</span><span class='line'>        <span class="n">expect</span><span class="p">(</span><span class="n">json_response</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">be_kits_root_json</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># More specific specs</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">describe</span> <span class="s2">&quot;requesting a kit&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">it</span> <span class="s2">&quot;conforms to the expected JSON structure&quot;</span> <span class="k">do</span>
</span><span class='line'>        <span class="n">get</span> <span class="n">kit_path</span><span class="p">(</span><span class="n">kit</span><span class="p">),</span> <span class="o">*</span><span class="n">options</span>
</span><span class='line'>        <span class="n">expect</span><span class="p">(</span><span class="n">json_response</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">be_kits_json</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># More specific specs</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># More state specs</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">context</span> <span class="s2">&quot;a developer user&quot;</span><span class="p">,</span> <span class="s2">&quot;sending request with parameter &#39;include&#39;&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="c1"># Setup world state</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">describe</span> <span class="s2">&quot;requesting the kits root&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">it</span> <span class="s2">&quot;conforms to the expected JSON structure with included resources&quot;</span> <span class="k">do</span>
</span><span class='line'>        <span class="n">get</span> <span class="n">kits_path</span><span class="p">(</span><span class="kp">include</span><span class="p">:</span> <span class="s2">&quot;beacons,beacon_attributes&quot;</span><span class="p">),</span> <span class="o">*</span><span class="n">options</span>
</span><span class='line'>        <span class="n">expect</span><span class="p">(</span><span class="n">json_response</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">be_kits_root_json</span><span class="o">.</span><span class="n">and</span><span class="p">(</span>
</span><span class='line'>          <span class="n">include_linked_resources</span><span class="p">(</span><span class="ss">:beacons</span><span class="p">,</span> <span class="ss">:beacon_attributes</span><span class="p">)</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">describe</span> <span class="s2">&quot;requesting a beacon&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">it</span> <span class="s2">&quot;conforms to the expected JSON structure with included resources&quot;</span> <span class="k">do</span>
</span><span class='line'>        <span class="n">get</span> <span class="n">kit_path</span><span class="p">(</span><span class="n">kit</span><span class="p">,</span> <span class="kp">include</span><span class="p">:</span> <span class="s2">&quot;beacons,beacon_attributes&quot;</span><span class="p">),</span> <span class="o">*</span><span class="n">options</span>
</span><span class='line'>        <span class="n">expect</span><span class="p">(</span><span class="n">json_response</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">be_kits_json</span><span class="o">.</span><span class="n">and</span><span class="p">(</span>
</span><span class='line'>          <span class="n">include_linked_resources</span><span class="p">(</span><span class="ss">:beacons</span><span class="p">,</span> <span class="ss">:beacon_attributes</span><span class="p">)</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The possibilities are fairly endless. We could improve this further by allowing
the factories to take model instances or attribute hashes. We can use those to
check specific content when available:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">account_resource</span><span class="p">(</span><span class="n">account</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">,</span> <span class="n">allow_nil</span><span class="p">:</span> <span class="kp">false</span><span class="p">)</span>
</span><span class='line'>  <span class="k">return</span> <span class="kp">nil</span> <span class="k">unless</span> <span class="n">account</span> <span class="o">||</span> <span class="o">!</span><span class="n">allow_nil</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">account</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="s1">&#39;id&#39;</span>   <span class="o">=&gt;</span> <span class="n">account</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span><span class='line'>      <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="n">account</span><span class="o">.</span><span class="n">name</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="s1">&#39;id&#39;</span>   <span class="o">=&gt;</span> <span class="no">Fixnum</span><span class="p">,</span>
</span><span class='line'>      <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="n">be_nil</span><span class="o">.</span><span class="n">or</span><span class="p">(</span><span class="n">be_a</span> <span class="nb">String</span><span class="p">),</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">kit_resource</span><span class="p">(</span><span class="n">kit</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">,</span> <span class="n">allow_nil</span><span class="p">:</span> <span class="kp">false</span><span class="p">)</span>
</span><span class='line'>  <span class="k">return</span> <span class="kp">nil</span> <span class="k">unless</span> <span class="n">kit</span> <span class="o">||</span> <span class="o">!</span><span class="n">allow_nil</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">kit</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="s1">&#39;id&#39;</span>        <span class="o">=&gt;</span> <span class="n">kit</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span><span class='line'>      <span class="s1">&#39;name&#39;</span>      <span class="o">=&gt;</span> <span class="n">kit</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span class='line'>      <span class="s1">&#39;api_token&#39;</span> <span class="o">=&gt;</span> <span class="n">kit</span><span class="o">.</span><span class="n">api_token</span><span class="p">,</span>
</span><span class='line'>      <span class="s1">&#39;account&#39;</span>   <span class="o">=&gt;</span> <span class="n">account_resource</span><span class="p">(</span><span class="n">kit</span><span class="o">.</span><span class="n">account</span><span class="p">,</span> <span class="n">allow_nil</span><span class="p">:</span> <span class="kp">true</span><span class="p">),</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="s1">&#39;id&#39;</span>        <span class="o">=&gt;</span> <span class="no">Fixnum</span><span class="p">,</span>
</span><span class='line'>      <span class="s1">&#39;name&#39;</span>      <span class="o">=&gt;</span> <span class="n">be_nil</span><span class="o">.</span><span class="n">or</span><span class="p">(</span><span class="n">be_a</span> <span class="nb">String</span><span class="p">),</span>
</span><span class='line'>      <span class="s1">&#39;api_token&#39;</span> <span class="o">=&gt;</span> <span class="nb">String</span><span class="p">,</span>
</span><span class='line'>      <span class="s1">&#39;account&#39;</span>   <span class="o">=&gt;</span> <span class="n">be_nil</span><span class="o">.</span><span class="n">or</span><span class="p">(</span><span class="n">match</span> <span class="n">account_resource</span><span class="p">),</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">context</span> <span class="s2">&quot;a basic user&quot;</span><span class="p">,</span> <span class="s2">&quot;with a kit having no beacons or maps&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="c1"># Setup world state</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">describe</span> <span class="s2">&quot;requesting the kits root&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">it</span> <span class="s2">&quot;conforms to the expected JSON structure&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">get</span> <span class="n">kits_path</span><span class="p">,</span> <span class="o">*</span><span class="n">options</span>
</span><span class='line'>      <span class="n">expect</span><span class="p">(</span><span class="n">json_response</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">be_kits_root_json</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">it</span> <span class="s2">&quot;has only the expected kit&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">get</span> <span class="n">kits_path</span><span class="p">,</span> <span class="o">*</span><span class="n">options</span>
</span><span class='line'>      <span class="n">expect</span><span class="p">(</span><span class="n">json_response</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="kp">include</span> <span class="s1">&#39;kits&#39;</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="n">kit_resource</span><span class="p">(</span><span class="n">basic_users_kit</span><span class="p">)</span><span class="o">]</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">describe</span> <span class="s2">&quot;requesting a beacon&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">it</span> <span class="s2">&quot;conforms to the expected JSON structure&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">get</span> <span class="n">kit_path</span><span class="p">(</span><span class="n">kit</span><span class="p">),</span> <span class="o">*</span><span class="n">options</span>
</span><span class='line'>      <span class="n">expect</span><span class="p">(</span><span class="n">json_response</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">be_kits_json</span><span class="p">(</span><span class="n">basic_users_kit</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Happy RSpec&#8217;ing!</p>

<h3>Updates 2014-09-30</h3>

<p>Thanks to everyone who provided feedback on this post. I&#8217;ve take it all into
consideration and made the following changes:</p>

<ul>
<li><p>The first code sample now shows the full spec file structure. This hopefully
makes the important distinction that the helper methods are not being defined
on <code>main</code>.</p></li>
<li><p>The line <code>require 'support/json_api_helpers'</code> isn&#8217;t loading another library.
Instead it is loading an extracted set of shared helper methods common to
nearly all JSON API request specs for this project. These have been extracted
to a module to keep them off of <code>main</code> and placed in <code>spec/support</code>.</p>

<p>This follows the new guidance that specs should only load those files which
they need. It also makes it easier for your future self and your co-workers
to come back to the file later and try to find where things are defined.</p>

<p>I&#8217;m including the file below for completeness:</p></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># spec/support/json_api_helpers.rb</span>
</span><span class='line'><span class="k">module</span> <span class="nn">MyApp</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">RSpec</span>
</span><span class='line'>    <span class="k">module</span> <span class="nn">JsonApiHelpers</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">json_response</span>
</span><span class='line'>        <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span> <span class="n">response</span><span class="o">.</span><span class="n">body</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">be_an_empty</span><span class="p">(</span><span class="n">klass</span><span class="p">)</span>
</span><span class='line'>        <span class="n">be_a</span><span class="p">(</span><span class="n">klass</span><span class="p">)</span><span class="o">.</span><span class="n">and</span><span class="p">(</span><span class="n">be_empty</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">all_match</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'>        <span class="n">all</span> <span class="n">match</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">RSpec</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">c</span><span class="o">|</span>
</span><span class='line'>  <span class="n">c</span><span class="o">.</span><span class="n">include</span> <span class="ss">MyApp</span><span class="p">:</span><span class="ss">:RSpec</span><span class="o">::</span><span class="no">JsonApiHelpers</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="ss">:request</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><p>It was pointed out that <code>all match</code> will handle the empty <code>Array</code> case.
It is possible to amend the above <code>be_an_empty(Array).or(all_match())</code>
to instead read: <code>be_an(Array).and(all_match())</code>.</p></li>
<li><p><a id="json-factory-helper1"></a>This is a helper method. My reference to it
as a factory was more explicitly attempting to describe it as a helper method
which instantiates another object. In Rails, people often know of &#8220;factories&#8221;
from the &#8220;factory vs fixture&#8221; debate. Often those factories are relatively
simple wrappers around constructors. After researching this a little more it
seems in the larger programming world &#8220;factory&#8221; is not the proper term.
Perhaps <a href="http://c2.com/cgi/wiki?CreationMethod">&#8220;creator&#8221;</a> is. I will move to
calling them helpers in the future.</p></li>
</ul>


		
		
	</div>

<div class="meta">
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014-02-24-ignite-those-horrible-scripts.html">
		
			Ignite Those Horrible Scripts</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2014-02-24T11:03:00-05:00" pubdate data-updated="true">Feb 24<span>th</span>, 2014</time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/script/'>script</a>, <a class='category' href='/blog/categories/shell/'>shell</a>, <a class='category' href='/blog/categories/zsh/'>zsh</a>


</div>
    </div>
		<p>The past week was spent dealing with an infuriating data crunching task.
<a href="https://twitter.com/crsexton">Chris</a> and I decided to celebrate by killing our
poorly written Ruby cli scripts with fire. Printing the scripts and going out
back to set them on fire would be more dramatic. Though it probably would be
appreciated by the other businesses which we share space with.</p>

<p>I took a breather and looked into <a href="http://www.zsh.org/">zsh</a> functions to
accomplish this. Here&#8217;s what I came up with:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>rageflip<span class="o">()</span> <span class="o">{</span> <span class="nb">echo</span> <span class="s2">&quot; ┻━┻ ︵ヽ(\`Д´)ﾉ︵ ┻━┻  $*&quot;</span> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>has_utility<span class="o">()</span> <span class="o">{</span> <span class="nb">hash</span> <span class="nv">$1</span> 2&gt;/dev/null <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Wrapper around `rm -rf` expressing callers loathing and disdain for the</span>
</span><span class='line'><span class="c"># provided files.</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># Inspiration was Homebrew&#39;s output:</span>
</span><span class='line'><span class="c"># 🍺  /usr/local/Cellar/tmux/1.9: 15 files, 628K, built in 25 seconds</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># For additional file stats, specific to code files, consider installing the</span>
</span><span class='line'><span class="c"># Count Lines of Code (cloc) tool: http://cloc.sourceforge.net/</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c">#   brew install cloc</span>
</span><span class='line'><span class="c">#   sudo apt-get install cloc</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'>ignite<span class="o">()</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">((</span> <span class="nv">$# </span><span class="o">==</span> 0 <span class="o">))</span> <span class="k">then </span><span class="nb">echo</span> <span class="s2">&quot;USAGE: ignite file [file] ...&quot;</span>; <span class="k">return</span>; <span class="k">fi</span>
</span><span class='line'><span class="k">  </span><span class="nb">local </span>total_lines
</span><span class='line'>  <span class="nb">local </span>human_size
</span><span class='line'>  <span class="nb">local </span>lc_blank
</span><span class='line'>  <span class="nb">local </span>lc_comment
</span><span class='line'>  <span class="nb">local </span>lc_code
</span><span class='line'>  <span class="nb">echo</span> <span class="s2">&quot;BURN IT ALL!!! $(rageflip)&quot;</span>
</span><span class='line'>  <span class="k">for </span>i <span class="k">do</span>
</span><span class='line'>    <span class="c"># If the file is empty we have 0 lines</span>
</span><span class='line'>    <span class="nv">human_size</span><span class="o">=</span><span class="k">$(</span>ls -lh <span class="nv">$i</span> | awk <span class="s1">&#39;{ print $5 }&#39;</span><span class="k">)</span>
</span><span class='line'>    <span class="nv">total_lines</span><span class="o">=</span><span class="k">${$(</span>sed -n <span class="s1">&#39;$=&#39;</span> <span class="nv">$i</span><span class="k">):-</span><span class="nv">0</span><span class="k">}</span>
</span><span class='line'>    <span class="nv">stats</span><span class="o">=</span><span class="s2">&quot;$total_lines lines&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if </span>has_utility cloc; <span class="k">then</span>
</span><span class='line'>      <span class="c"># Setup some local variables regarding file stats</span>
</span><span class='line'>      <span class="nv">lc_blank</span><span class="o">=</span>
</span><span class='line'>      <span class="nv">lc_comment</span><span class="o">=</span>
</span><span class='line'>      <span class="nv">lc_code</span><span class="o">=</span>
</span><span class='line'>      <span class="nb">eval</span> <span class="k">$(</span>
</span><span class='line'>        cloc <span class="nv">$i</span> --quiet | tail -2 | head -1 |
</span><span class='line'>        awk <span class="s1">&#39;{ print &quot;lc_blank=&quot;$3, &quot;lc_comment=&quot;$4, &quot;lc_code=&quot;$5 }&#39;</span>
</span><span class='line'>      <span class="k">)</span>
</span><span class='line'>      <span class="k">if</span> <span class="o">[</span> ! -z <span class="nv">$lc_blank</span> <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">        </span><span class="nv">stats</span><span class="o">=</span><span class="s2">&quot;$lc_code loc, $lc_comment comments, $lc_blank whitespace lines&quot;</span>
</span><span class='line'>      <span class="k">fi</span>
</span><span class='line'><span class="k">    fi</span>
</span><span class='line'>
</span><span class='line'><span class="k">    </span>rm -rf <span class="nv">$i</span>
</span><span class='line'>    <span class="nb">echo</span> <span class="s2">&quot;🔥  $i: $stats, $human_size&quot;</span>
</span><span class='line'>  <span class="k">done</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we can sit back and watch it all burn:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>ignite script/crunch-*
</span><span class='line'>BURN IT ALL!!!  ┻━┻ ︵ヽ<span class="o">(</span><span class="sb">`</span>Д´<span class="o">)</span>ﾉ︵ ┻━┻
</span><span class='line'>🔥  script/crunch-dump-sessions: 5 loc, 5 comments, 2 whitespace lines, 330B
</span><span class='line'>🔥  script/crunch-normalize: 47 loc, 14 comments, 11 whitespace lines, 2.2K
</span><span class='line'>🔥  script/crunch-import-csv: 101 loc, 2 comments, 20 whitespace lines, 2.7K
</span><span class='line'>🔥  script/crunch-timestamp: 203 loc, 44 comments, 38 whitespace lines, 8.4K
</span></code></pre></td></tr></table></div></figure>


<p>Though at this point, it might as well be a full script file. If I do that, I
might as well just write it as a Ruby cli&#8230;</p>

		
		
	</div>

<div class="meta">
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014-02-17-pitfalls-of-testing-scripts-with-load-part-2.html">
		
			Pitfalls of Testing Scripts With Load - Part 2</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2014-02-17T10:15:00-05:00" pubdate data-updated="true">Feb 17<span>th</span>, 2014</time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/ruby/'>ruby</a>, <a class='category' href='/blog/categories/script/'>script</a>, <a class='category' href='/blog/categories/testing/'>testing</a>


</div>
    </div>
		<p><small>
<em>Check out the full Testing Scripts with Load series:
<a href="http://aaronkromer.com/blog/2013-07-11-testing-scripts-with-load.html">part 1</a>,
<a href="http://aaronkromer.com/blog/2013-07-29-pitfalls-of-testing-scripts-with-load-part-1.html">part 2</a>,
<a href="http://aaronkromer.com/blog/2014-02-17-pitfalls-of-testing-scripts-with-load-part-2.html">part 3</a></em>
</small></p>

<h2>Scope Smashing</h2>

<p>Take the following script and spec:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#!/usr/bin/env ruby</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">current_user</span>
</span><span class='line'>  <span class="s1">&#39;Bob&#39;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">current_user</span>
</span><span class='line'>  <span class="s1">&#39;Alice&#39;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">describe</span> <span class="s1">&#39;Running the server locally&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">it</span> <span class="s1">&#39;logs that it is running&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">load</span> <span class="s1">&#39;script/current-user-smash&#39;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">expect</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span> <span class="s1">&#39;Alice&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Alas, the spec fails with:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="ss">expected</span><span class="p">:</span> <span class="s2">&quot;Alice&quot;</span>
</span><span class='line'>     <span class="ss">got</span><span class="p">:</span> <span class="s2">&quot;Bob&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is due to how <a href="http://ruby-doc.org/core-2.1.0/Kernel.html#method-i-load"><code>load</code></a> works:</p>

<blockquote><p>If the optional <code>wrap</code> parameter is <code>true</code>, the loaded script will be
executed under an anonymous module, protecting the calling program’s global
namespace. In no circumstance will any local variables in the loaded file be
propagated to the loading environment.</p></blockquote>

<p>While it is easy to spot the issue this time, that&#8217;s not normally the case.
Say if the additional method is define by a gem or in supporting file. Or if
you are testing multiple scripts that each define the same top-level methods.
These conditions will result in very strange and difficult to debug failures.
Of course, it&#8217;s always a good idea to not define top-level methods to begin
with.</p>

<p>Instead always pass the additional <code>wrap</code> parameter. Here I&#8217;ve named it as a
descriptive inline variable to reveal it&#8217;s intent:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">it</span> <span class="s1">&#39;logs that it is running&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="nb">load</span> <span class="s1">&#39;script/current-user-smash&#39;</span><span class="p">,</span> <span class="n">_in_sandbox</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">expect</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span> <span class="s1">&#39;Alice&#39;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


		
		
	</div>

<div class="meta">
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014-02-06-open-classes-and-monkey-patching-at-retroruby.html">
		
			Discussion About Open Classes and Monkey Patching at #retroruby</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2014-02-06T15:28:00-05:00" pubdate data-updated="true">Feb 6<span>th</span>, 2014</time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/retroruby/'>retroruby</a>, <a class='category' href='/blog/categories/ruby/'>ruby</a>


</div>
    </div>
		<p>While at <a href="http://retroruby.org">RetroRuby 2014</a> a very good question was asked
in the newbie track. The following code sample had just been shown on some
basic awesomeness of Ruby:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="s2">&quot;Words&quot;</span> <span class="o">*</span> <span class="mi">2</span>
</span><span class='line'><span class="c1"># =&gt; &quot;WordsWords&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>One of the participants then asked why that worked but the inverse didn&#8217;t:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="mi">2</span> <span class="o">*</span> <span class="s2">&quot;Words&quot;</span>
</span><span class='line'><span class="c1"># TypeError: String can&#39;t be coerced into Fixnum</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Oops what just happened?</h2>

<p>In Ruby, virtually everything is accomplished by sending a message to another
object. Above we would say:</p>

<blockquote><p><em>Send the message <code>*</code> to <code>"Words"</code> with parameter <code>2</code></em></p>

<p><em>Send the message <code>*</code> to <code>2</code> with parameter <code>"Words"</code></em></p></blockquote>

<p>&#8220;Sending a message&#8221; is the Java equivalent of calling a method. Another way to
write the above is:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="s2">&quot;Words&quot;</span><span class="o">.</span><span class="n">*</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span class='line'><span class="c1"># =&gt; &quot;WordsWords&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here we used the normal &#8220;method&#8221; calling syntax: <code>obj.method(args)</code></p>

<p>You&#8217;ll also probably see the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="s2">&quot;Words&quot;</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="ss">:*</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span class='line'><span class="c1"># =&gt; &quot;WordsWords&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This time we explicitly sent the message: <code>obj.send(message, args)</code></p>

<p>With <a href="http://ruby-doc.org/core-2.1.0/Object.html#method-i-send"><code>send</code></a> Ruby
doesn&#8217;t check if the message you passed was supposed to be public or private.
Generally, what you wanted to do was dynamically send the message while still
making sure to respect the public API of the object. To do this you should use
<a href="http://ruby-doc.org/core-2.1.0/Object.html#method-i-public_send"><code>public_send</code></a>
instead: <code>obj.public_send(message, args)</code>.</p>

<p>So back to the original issue. Both
<a href="http://ruby-doc.org/core-2.1.0/String.html"><code>String</code></a> and
<a href="http://ruby-doc.org/core-2.1.0/Fixnum.html"><code>Fixnum</code></a> respond to the message
<code>*</code>.</p>

<ul>
<li><a href="http://ruby-doc.org/core-2.1.0/String.html#method-i-2A"><code>String#*</code></a></li>
<li><a href="http://ruby-doc.org/core-2.1.0/Fixnum.html#method-i-2A"><code>Fixnum#*</code></a></li>
</ul>


<p>However, <code>String</code>&#8217;s implementation knows what to do when the argument is a
<code>Fixnum</code>. When we reverse it, the <code>Fixnum</code> implementation doesn&#8217;t understand
what to do with a <code>String</code> argument.</p>

<h2>How to fix this?</h2>

<p>Well you probably shouldn&#8217;t. But just for fun we&#8217;ll use Ruby&#8217;s open class
behavior to monkey patch <code>Fixnum</code>&#8217;s <code>*</code> implementation.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Fixnum</span> <span class="c1"># We just re-opened the class</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">*</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="c1"># We&#39;re redefining the * message - this destroys the</span>
</span><span class='line'>             <span class="c1"># previous implementation!!!</span>
</span><span class='line'>    <span class="n">arg</span> <span class="o">*</span> <span class="nb">self</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="mi">2</span> <span class="o">*</span> <span class="s2">&quot;Words&quot;</span>
</span><span class='line'><span class="c1"># =&gt; WordsWords</span>
</span></code></pre></td></tr></table></div></figure>


<p>It worked!! Before you go doing this to everything, be aware we&#8217;ve now lost the
ability to do normal multiplication. Additionally, we&#8217;ll overflow the stack
trying to multiply two <code>Fixnum</code>s.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="mi">2</span> <span class="o">*</span> <span class="mi">2</span>
</span><span class='line'><span class="c1"># SystemStackError: stack level too deep</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Wrap Up</h2>

<p>In Ruby, most things are messages sent from one object to another. Some times
the language gives a little extra syntactic sugar to make sending the message
more readable.</p>

<p>Additionally, open classes and monkey patching have their uses. Just be aware
that with great power comes great responsibility. Always stop to ask yourself
if this is really a good idea; and try to never change existing behavior if you
can.</p>

<h2>Level Up!</h2>

<p>So what if we just wanted to extend the existing functionality.  There are a
lot of ways to do this and covering each, along with the pros and cons is very
out of scope for this post. I&#8217;m just going to demonstrate one way to illustrate
how it could be done.</p>

<p>You&#8217;ll need a new irb or Pry session so we get the original implementation for
<code>Fixnum</code> back.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Fixnum</span> <span class="c1"># We just re-opened the class</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># We need to store a reference to the original implementation One way to do</span>
</span><span class='line'>  <span class="c1"># this is to create an alias for the original implementation so we can call</span>
</span><span class='line'>  <span class="c1"># it later. Be sure to pick a descriptive name so that it isn&#39;t accidentally</span>
</span><span class='line'>  <span class="c1"># overwritten by something else.</span>
</span><span class='line'>  <span class="k">alias</span> <span class="ss">:star_without_string_support</span> <span class="ss">:*</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">*</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="c1"># Redefine the message destroying the previous implementation!!!</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">is_a?</span> <span class="nb">String</span>
</span><span class='line'>      <span class="n">arg</span> <span class="o">*</span> <span class="nb">self</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">star_without_string_support</span> <span class="n">arg</span>  <span class="c1"># use the original implementation</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


		
		
	</div>

<div class="meta">
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2013-12-10-live-ing-dangerously-with-rails.html">
		
			Live-ing Dangerously With Rails</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2013-12-10T13:08:00-05:00" pubdate data-updated="true">Dec 10<span>th</span>, 2013</time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/rails/'>rails</a>, <a class='category' href='/blog/categories/ruby/'>ruby</a>


</div>
    </div>
		<p>Recently at work, we&#8217;ve been spinning up a bunch of demo apps on Heroku. This
has worked out well for us so far. However, some of these apps require
background data crunching. This hasn&#8217;t been a problem as we just add a Rake
task, or two, and set the Heroku scheduler to take care of things.</p>

<p>Then comes the day when the sales team says:</p>

<blockquote><p>&#8220;Oh hey. Can we re-run all the numbers but with different configurations?&#8221;</p></blockquote>

<p>Sure, that&#8217;s not a problem you think:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>heroku run rake redo_all_the_things<span class="o">[</span>config.yml<span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>However, there&#8217;s a few issues with this:</p>

<ol>
<li>The <code>config.yml</code> needs to be on Heroku</li>
<li>This counts against your active dyno time</li>
</ol>


<p>See the thing is, Heroku <a href="https://devcenter.heroku.com/articles/read-only-filesystem">doesn&#8217;t let you create files</a>
that aren&#8217;t already in your VC system from outside the app. It&#8217;s now
<a href="https://devcenter.heroku.com/articles/dynos#ephemeral-filesystem">sorta possible on Cedar</a>,
but not really for this purpose.</p>

<p>Additionally, if these tasks turn out to be long running, that&#8217;ll quickly eat
up the overhead on the &#8216;free&#8217; dyno. For demo apps of non-paying customers
that&#8217;s not always an option.</p>

<p>Enter the <code>live</code> environment.</p>

<p>Just add a new <code>live</code> environment to the Rails application. This allows us to
run Rake locally, but against the production database. Additionally, allowing
for custom configuration files to just be stored on our local system. And we
don&#8217;t spin up a new dyno on Heroku.  Win, win!</p>

<p>To set this up:</p>

<ul>
<li>Update the <code>Gemfile</code></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Gemfile</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># We use dotenv-rails to help manage environment configs locally.</span>
</span><span class='line'><span class="c1"># Add our new environment:</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;dotenv-rails&#39;</span><span class="p">,</span> <span class="ss">groups</span><span class="p">:</span> <span class="o">[</span><span class="ss">:development</span><span class="p">,</span> <span class="ss">:test</span><span class="p">,</span> <span class="ss">:live</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Add the live specific sample file: <code>.env.live-example</code></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># .env.live-example</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Rename this file to `.env.live` and it will be automatically sourced by</span>
</span><span class='line'><span class="c1"># rails. Uncomment the settings for them to be picked up.</span>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="c1"># Grab the settings from the output of:</span>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="c1">#  $ heroku config</span>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="c1"># Running against the Heroku production DB directly</span>
</span><span class='line'><span class="c1"># BE CAREFUL!! YOU HAVE BEEN WARNED!!</span>
</span><span class='line'><span class="c1">#DATABASE_NAME=WARNING</span>
</span><span class='line'><span class="c1">#DATABASE_HOST=DANGER</span>
</span><span class='line'><span class="c1">#DATABASE_PORT=WILL</span>
</span><span class='line'><span class="c1">#DATABASE_USER=ROBINSON</span>
</span><span class='line'><span class="c1">#DATABASE_PASSWORD=SERIOUSLY</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Update the <code>database.yml</code> file</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="c1"># config/database.yml</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">live</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">adapter</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">postgresql</span>
</span><span class='line'>  <span class="l-Scalar-Plain">encoding</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">unicode</span>
</span><span class='line'>  <span class="l-Scalar-Plain">database</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= ENV[&#39;DATABASE_NAME&#39;] %&gt;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">host</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= ENV[&#39;DATABASE_HOST&#39;] %&gt;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">port</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= ENV[&#39;DATABASE_PORT&#39;] %&gt;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">username</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= ENV[&#39;DATABASE_USER&#39;] %&gt;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">password</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= ENV[&#39;DATABASE_PASSWORD&#39;] %&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Copy <code>config/environments/production.rb</code> to <code>config/environments/live.rb</code>.
If you wish to symlink it instead <a href="http://stackoverflow.com/questions/954560/what-does-git-do-to-files-that-are-a-symbolic-link">be wary of how git treats that</a>.</li>
</ul>


<p>Now running our tasks is as simple as:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ RAILS_ENV</span><span class="o">=</span>live rake redo_all_the_things<span class="o">[</span>config-fun-edition.yml<span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


		
		
	</div>

<div class="meta">
	
</div>
</article>

<nav id="pagenavi">
    
    
        <a href="/blog/page/2/" class="next">Next</a>
    
    <div class="center"><a href="/blog/archives">Blog Archives</a></div>
</nav>

    </div>
    <footer id="footer">
    <div style="display:inline">
  <p>
    Copyright &copy; 2014

    Aaron Kromer
.
    All content on this site is available under a <a href="http://creativecommons.org/publicdomain/zero/1.0/">CC0 license</a>.
  </p>
  <p>
    Powered by <a href="http://octopress.org">Octopress</a> |
    Theme based on <a href="http://github.com/panks/fabric">fabric</a> by <a href="http://panks.me">Pankaj Kumar</a>
  </p>
</div>


    </footer>
    <script src="/javascripts/fabric.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->






<!-- end toload --> 
</div>
</div>
<script src="/javascripts/jquery.ui.totop.js" type="text/javascript"></script>
<script type="text/javascript">
/*<![CDATA[*/
;(function($){$().UItoTop({easingType:'easeOutCirc'});})(jQuery); 
/*]]>*/
</script><!-- remove it to remove the scroll to top button -->
</body>
</html>
