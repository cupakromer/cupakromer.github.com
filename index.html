
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>Aaron Kromer's Blog</title>
    <meta name="author" content="Aaron Kromer">
    
	<meta name="description" content="Published on: Feb 6th, 2014 Tags: retroruby, ruby While at RetroRuby 2014 a very good question was asked
in the newbie track. The following code &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="Aaron Kromer's Blog" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.ico" rel="shortcut icon">
    <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">

    <link href='http://fonts.googleapis.com/css?family=Slackey' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Amethysta' rel='stylesheet' type='text/css'>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
    <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

    <script type="text/javascript" src="/javascripts/jquery-tapir.js"></script>

    <!-- remove or comment it to disable ajaxification -->   
    <script src="/javascripts/ajaxify.js"></script>
   
    
    
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-34364108-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>


</head>


<body>
    <div id="wrapper">
    <header id="header" class="inner"><!-- for more effects see _animate.scss -->
<hgroup id="headerbg">
  <h1><a href="/">Aaron Kromer's Blog</a></h1>
  
    <h2>A little cup'a Kromer with your code</h2>
  
</hgroup>

<ul id="social-links">
  
  <!-- GitHub -->
  <li>
    <a href="https://github.com/cupakromer" title="GitHub">
      <i class="foundicon-github"></i>
    </a>
  </li>
  
  
  
  
  <!-- Twitter -->
  <li>
    <a href="http://www.twitter.com/cupakromer" title="Twitter">
      <i class="foundicon-twitter"></i>
    </a>
  </li>
  
  
  
  
  <li>
    <a href="/atom.xml">
      <i class="foundicon-rss"></i>
    </a>
  </li>
</ul>


<!-- use full url including 'index.html' for navigation bar if you are using ajax -->
<ul id="nav">
  <li id="ajax"><a href="/index.html">Home</a></li>
  <li id="ajax"><a href="/blog/archives/index.html">Archives</a></li>
  
  <li>
    <div id="dark">
      <form method="get" action="/search.html" id="search">
        <input name="query" type="text" placeholder="Search..." x-webkit-speech />
      </form>
    </div>
  </li>
  
</ul>




</header>

<div id="toload">
<!-- begin toload --> 
    <div id="content" class="inner">
        


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014-02-06-open-classes-and-monkey-patching-at-retroruby.html">
		
			Discussion About Open Classes and Monkey Patching at #retroruby</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2014-02-06T15:28:00-05:00" pubdate data-updated="true">Feb 6<span>th</span>, 2014</time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/retroruby/'>retroruby</a>, <a class='category' href='/blog/categories/ruby/'>ruby</a>


</div>
    </div>
		<p>While at <a href="http://retroruby.org">RetroRuby 2014</a> a very good question was asked
in the newbie track. The following code sample had just been shown on some
basic awesomeness of Ruby:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="s2">&quot;Words&quot;</span> <span class="o">*</span> <span class="mi">2</span>
</span><span class='line'><span class="c1"># =&gt; &quot;WordsWords&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>One of the participants then asked why that worked but the inverse didn&#8217;t:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="mi">2</span> <span class="o">*</span> <span class="s2">&quot;Words&quot;</span>
</span><span class='line'><span class="c1"># TypeError: String can&#39;t be coerced into Fixnum</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Oops what just happened?</h2>

<p>In Ruby, virtually everything is accomplished by sending a message to another
object. Above we would say:</p>

<blockquote><p><em>Send the message <code>*</code> to <code>"Words"</code> with parameter <code>2</code></em></p>

<p><em>Send the message <code>*</code> to <code>2</code> with parameter <code>"Words"</code></em></p></blockquote>

<p>&#8220;Sending a message&#8221; is the Java equivalent of calling a method. Another way to
write the above is:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="s2">&quot;Words&quot;</span><span class="o">.</span><span class="n">*</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span class='line'><span class="c1"># =&gt; &quot;WordsWords&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here we used the normal &#8220;method&#8221; calling syntax: <code>obj.method(args)</code></p>

<p>You&#8217;ll also probably see the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="s2">&quot;Words&quot;</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="ss">:*</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span class='line'><span class="c1"># =&gt; &quot;WordsWords&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This time we explicitly sent the message: <code>obj.send(message, args)</code></p>

<p>With <a href="http://ruby-doc.org/core-2.1.0/Object.html#method-i-send"><code>send</code></a> Ruby
doesn&#8217;t check if the message you passed was supposed to be public or private.
Generally, what you wanted to do was dynamically send the message while still
making sure to respect the public API of the object. To do this you should use
<a href="http://ruby-doc.org/core-2.1.0/Object.html#method-i-public_send"><code>public_send</code></a>
instead: <code>obj.public_send(message, args)</code>.</p>

<p>So back to the original issue. Both
<a href="http://ruby-doc.org/core-2.1.0/String.html"><code>String</code></a> and
<a href="http://ruby-doc.org/core-2.1.0/Fixnum.html"><code>Fixnum</code></a> respond to the message
<code>*</code>.</p>

<ul>
<li><a href="http://ruby-doc.org/core-2.1.0/String.html#method-i-2A"><code>String#*</code></a></li>
<li><a href="http://ruby-doc.org/core-2.1.0/Fixnum.html#method-i-2A"><code>Fixnum#*</code></a></li>
</ul>


<p>However, <code>String</code>&#8217;s implementation knows what to do when the argument is a
<code>Fixnum</code>. When we reverse it, the <code>Fixnum</code> implementation doesn&#8217;t understand
what to do with a <code>String</code> argument.</p>

<h2>How to fix this?</h2>

<p>Well you probably shouldn&#8217;t. But just for fun we&#8217;ll use Ruby&#8217;s open class
behavior to monkey patch <code>Fixnum</code>&#8217;s <code>*</code> implementation.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Fixnum</span> <span class="c1"># We just re-opened the class</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">*</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="c1"># We&#39;re redefining the * message - this destroys the</span>
</span><span class='line'>             <span class="c1"># previous implementation!!!</span>
</span><span class='line'>    <span class="n">arg</span> <span class="o">*</span> <span class="nb">self</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="mi">2</span> <span class="o">*</span> <span class="s2">&quot;Words&quot;</span>
</span><span class='line'><span class="c1"># =&gt; WordsWords</span>
</span></code></pre></td></tr></table></div></figure>


<p>It worked!! Before you go doing this to everything, be aware we&#8217;ve now lost the
ability to do normal multiplication. Additionally, we&#8217;ll overflow the stack
trying to multiply two <code>Fixnum</code>s.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="mi">2</span> <span class="o">*</span> <span class="mi">2</span>
</span><span class='line'><span class="c1"># SystemStackError: stack level too deep</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Wrap Up</h2>

<p>In Ruby, most things are messages sent from one object to another. Some times
the language gives a little extra syntactic sugar to make sending the message
more readable.</p>

<p>Additionally, open classes and monkey patching have their uses. Just be aware
that with great power comes great responsibility. Always stop to ask yourself
if this is really a good idea; and try to never change existing behavior if you
can.</p>

<h2>Level Up!</h2>

<p>So what if we just wanted to extend the existing functionality.  There are a
lot of ways to do this and covering each, along with the pros and cons is very
out of scope for this post. I&#8217;m just going to demonstrate one way to illustrate
how it could be done.</p>

<p>You&#8217;ll need a new irb or Pry session so we get the original implementation for
<code>Fixnum</code> back.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Fixnum</span> <span class="c1"># We just re-opened the class</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># We need to store a reference to the original implementation One way to do</span>
</span><span class='line'>  <span class="c1"># this is to create an alias for the original implementation so we can call</span>
</span><span class='line'>  <span class="c1"># it later. Be sure to pick a descriptive name so that it isn&#39;t accidentally</span>
</span><span class='line'>  <span class="c1"># overwritten by something else.</span>
</span><span class='line'>  <span class="k">alias</span> <span class="ss">:star_without_string_support</span> <span class="ss">:*</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">*</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="c1"># Redefine the message destroying the previous implementation!!!</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">is_a?</span> <span class="nb">String</span>
</span><span class='line'>      <span class="n">arg</span> <span class="o">*</span> <span class="nb">self</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">star_without_string_support</span> <span class="n">arg</span>  <span class="c1"># use the original implementation</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


		
		
	</div>

<div class="meta">
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2013-12-10-live-ing-dangerously-with-rails.html">
		
			Live-ing Dangerously With Rails</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2013-12-10T13:08:00-05:00" pubdate data-updated="true">Dec 10<span>th</span>, 2013</time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/rails/'>rails</a>, <a class='category' href='/blog/categories/ruby/'>ruby</a>


</div>
    </div>
		<p>Recently at work, we&#8217;ve been spinning up a bunch of demo apps on Heroku. This
has worked out well for us so far. However, some of these apps require
background data crunching. This hasn&#8217;t been a problem as we just add a Rake
task, or two, and set the Heroku scheduler to take care of things.</p>

<p>Then comes the day when the sales team says:</p>

<blockquote><p>&#8220;Oh hey. Can we re-run all the numbers but with different configurations?&#8221;</p></blockquote>

<p>Sure, that&#8217;s not a problem you think:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>heroku run rake redo_all_the_things<span class="o">[</span>config.yml<span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>However, there&#8217;s a few issues with this:</p>

<ol>
<li>The <code>config.yml</code> needs to be on Heroku</li>
<li>This counts against your active dyno time</li>
</ol>


<p>See the thing is, Heroku <a href="https://devcenter.heroku.com/articles/read-only-filesystem">doesn&#8217;t let you create files</a>
that aren&#8217;t already in your VC system from outside the app. It&#8217;s now
<a href="https://devcenter.heroku.com/articles/dynos#ephemeral-filesystem">sorta possible on Cedar</a>,
but not really for this purpose.</p>

<p>Additionally, if these tasks turn out to be long running, that&#8217;ll quickly eat
up the overhead on the &#8216;free&#8217; dyno. For demo apps of non-paying customers
that&#8217;s not always an option.</p>

<p>Enter the <code>live</code> environment.</p>

<p>Just add a new <code>live</code> environment to the Rails application. This allows us to
run Rake locally, but against the production database. Additionally, allowing
for custom configuration files to just be stored on our local system. And we
don&#8217;t spin up a new dyno on Heroku.  Win, win!</p>

<p>To set this up:</p>

<ul>
<li>Update the <code>Gemfile</code></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Gemfile</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># We use dotenv-rails to help manage environment configs locally.</span>
</span><span class='line'><span class="c1"># Add our new environment:</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;dotenv-rails&#39;</span><span class="p">,</span> <span class="ss">groups</span><span class="p">:</span> <span class="o">[</span><span class="ss">:development</span><span class="p">,</span> <span class="ss">:test</span><span class="p">,</span> <span class="ss">:live</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Add the live specific sample file: <code>.env.live-example</code></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># .env.live-example</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Rename this file to `.env.live` and it will be automatically sourced by</span>
</span><span class='line'><span class="c1"># rails. Uncomment the settings for them to be picked up.</span>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="c1"># Grab the settings from the output of:</span>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="c1">#  $ heroku config</span>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="c1"># Running against the Heroku production DB directly</span>
</span><span class='line'><span class="c1"># BE CAREFUL!! YOU HAVE BEEN WARNED!!</span>
</span><span class='line'><span class="c1">#DATABASE_NAME=WARNING</span>
</span><span class='line'><span class="c1">#DATABASE_HOST=DANGER</span>
</span><span class='line'><span class="c1">#DATABASE_PORT=WILL</span>
</span><span class='line'><span class="c1">#DATABASE_USER=ROBINSON</span>
</span><span class='line'><span class="c1">#DATABASE_PASSWORD=SERIOUSLY</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Update the <code>database.yml</code> file</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="c1"># config/database.yml</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">live</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">adapter</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">postgresql</span>
</span><span class='line'>  <span class="l-Scalar-Plain">encoding</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">unicode</span>
</span><span class='line'>  <span class="l-Scalar-Plain">database</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= ENV[&#39;DATABASE_NAME&#39;] %&gt;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">host</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= ENV[&#39;DATABASE_HOST&#39;] %&gt;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">port</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= ENV[&#39;DATABASE_PORT&#39;] %&gt;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">username</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= ENV[&#39;DATABASE_USER&#39;] %&gt;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">password</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= ENV[&#39;DATABASE_PASSWORD&#39;] %&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Copy <code>config/environments/production.rb</code> to <code>config/environments/live.rb</code>.
If you wish to symlink it instead <a href="http://stackoverflow.com/questions/954560/what-does-git-do-to-files-that-are-a-symbolic-link">be wary of how git treats that</a>.</li>
</ul>


<p>Now running our tasks is as simple as:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ RAILS_ENV</span><span class="o">=</span>live rake redo_all_the_things<span class="o">[</span>config-fun-edition.yml<span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


		
		
	</div>

<div class="meta">
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2013-07-29-pitfalls-of-testing-scripts-with-load-part-1.html">
		
			Pitfalls of Testing Scripts With Load - Part 1</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2013-07-29T13:29:00-04:00" pubdate data-updated="true">Jul 29<span>th</span>, 2013</time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/ruby/'>ruby</a>, <a class='category' href='/blog/categories/script/'>script</a>, <a class='category' href='/blog/categories/testing/'>testing</a>


</div>
    </div>
		<p>Previously it was shown how to <a href="http://aaronkromer.com/blog/2013-07-11-testing-scripts-with-load.html">use load to test scripts</a>. As with all techniques, there are some drawbacks to using <code>load</code>.</p>

<h3>Hidden Require Dependency</h3>

<p>Take script:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#!/usr/bin/env ruby</span>
</span><span class='line'><span class="vg">$:</span><span class="o">.</span><span class="n">unshift</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span> <span class="no">File</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">__FILE__</span><span class="p">),</span> <span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;lib&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;local_server&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">logger</span> <span class="o">=</span> <span class="no">Logger</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vg">$stderr</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="no">LocalServer</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">logger</span><span class="p">)</span><span class="o">.</span><span class="n">run</span>
</span></code></pre></td></tr></table></div></figure>


<p>and passing spec:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;logger&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;stringio&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">describe</span> <span class="s1">&#39;Running the server locally&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">it</span> <span class="s1">&#39;logs that it is running&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">io</span> <span class="o">=</span> <span class="no">StringIO</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>    <span class="n">allow</span><span class="p">(</span><span class="no">Logger</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:new</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="no">Logger</span><span class="o">.</span><span class="n">new</span> <span class="n">io</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">expect</span><span class="p">{</span> <span class="nb">load</span> <span class="s1">&#39;script/local-server&#39;</span> <span class="p">}</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">{</span> <span class="n">io</span><span class="o">.</span><span class="n">string</span> <span class="p">}</span>
</span><span class='line'>      <span class="o">.</span><span class="n">to</span> <span class="kp">include</span> <span class="s1">&#39;SERVER: starting up&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>However, when the script is run standalone, it errors with:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">uninitialized</span> <span class="n">constant</span> <span class="no">Logger</span> <span class="p">(</span><span class="no">NameError</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Be aware that since <a href="http://ruby-doc.org/core-2.0/Kernel.html#method-i-load"><code>load</code></a>
happens in the current spec context, a missing <code>require</code> may not be noticed if
it is required by the spec.</p>

<p>Whenever possible have at least one test that shells out as a sanity check.</p>

		
		
	</div>

<div class="meta">
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2013-07-26-monitoring-specific-messages-in-rspec-part-3.html">
		
			Monitoring Specific Messages in RSpec Part 3</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2013-07-26T10:13:00-04:00" pubdate data-updated="true">Jul 26<span>th</span>, 2013</time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/rspec/'>rspec</a>, <a class='category' href='/blog/categories/ruby/'>ruby</a>


</div>
    </div>
		<p>Continuing the series (
<a href="http://aaronkromer.com/blog/2013-07-17-monitoring-specific-messages-in-rspec.html">part 1</a>,
<a href="http://aaronkromer.com/blog/2013-07-24-monitoring-specific-messages-in-rspec-part-2.html">part 2</a>
) on matching messages in RSpec, the next logical step is custom argument
matchers.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">expect</span><span class="p">(</span><span class="n">mechanic</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:fix</span><span class="p">)</span><span class="o">.</span><span class="n">with</span> <span class="n">something_broken</span>
</span></code></pre></td></tr></table></div></figure>


<p>Using the RSpec <a href="https://www.relishapp.com/rspec/rspec-expectations/v/2-14/docs/custom-matchers">matcher DSL</a>
this could simply look like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="ss">RSpec</span><span class="p">:</span><span class="ss">:Matchers</span><span class="o">.</span><span class="n">define</span> <span class="ss">:something_broken</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">match</span> <span class="k">do</span> <span class="o">|</span><span class="n">thing</span><span class="o">|</span>
</span><span class='line'>    <span class="n">thing</span><span class="o">.</span><span class="n">broken?</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>That&#8217;s all there is to it. Now it can be used as both a regular matcher and as
an argument matcher.</p>

<p>If the matcher needs to be created from
<a href="http://rubydoc.info/gems/rspec-expectations/RSpec/Matchers">scratch</a>, a
<code>matches?</code> method must be defined instead:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">SomethingBroken</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">matches?</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
</span><span class='line'>    <span class="n">target</span><span class="o">.</span><span class="n">broken?</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">something_broken</span>
</span><span class='line'>  <span class="no">SomethingBroken</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This works just fine as a normal matcher, however, when used as an argument
matcher, it will always fail. The reason is that argument matchers are invoked
with the <code>==</code> operator, which by <a href="http://ruby-doc.org/core-2.0/BasicObject.html#method-i-3D-3D">default</a>,
verifies if the objects are the same object.</p>

<p>Attempting to use a normal matcher with the
<a href="https://www.relishapp.com/rspec/rspec-expectations/v/2-14/docs/built-in-matchers/expect-change"><code>change</code></a>
expectation also
<a href="https://github.com/rspec/rspec-expectations/issues/276">oddly</a> fails, due to
<code>change</code> invoking the
<a href="http://aaronkromer.com/blog/2012-10-12-equals-equals-equals-the-forgotten-equality.html"><code>===</code></a>
message, not <code>matches?</code>. Since the <a href="http://ruby-doc.org/core-2.0/Object.html#method-i-3D-3D-3D">default <code>===</code> behavior is
<code>==</code></a>, the existing
argument matchers currently work with it.</p>

<p>There is active talk / changes
<a href="https://github.com/rspec/rspec-expectations/issues/280">happening</a> to
standardize the matchers to <code>===</code>. This will allow for a more consistent and
composable interface. It also has the added benefit of allowing the matchers to
be used in more complex conditionals using <code>case</code> statements.</p>

<p>To fix the class based matcher simply add the necessary alias(es):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">SomethingBroken</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">matches?</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
</span><span class='line'>    <span class="n">target</span><span class="o">.</span><span class="n">broken?</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="n">alias_method</span> <span class="ss">:==</span><span class="p">,</span> <span class="ss">:matches?</span>
</span><span class='line'>  <span class="n">alias_method</span> <span class="ss">:===</span><span class="p">,</span> <span class="ss">:matches?</span>  <span class="c1"># Not technically necessary due to default ==</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note that with such a simple matcher, there is no reason it cannot be created
as a simple composed method using an existing matcher:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">something_broken</span>
</span><span class='line'>  <span class="n">be_broken</span>   <span class="c1"># Note: Not all built in matchers have == aliases yet</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


		
		
	</div>

<div class="meta">
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2013-07-24-monitoring-specific-messages-in-rspec-part-2.html">
		
			Monitoring Specific Messages in RSpec Part 2</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2013-07-24T10:11:00-04:00" pubdate data-updated="true">Jul 24<span>th</span>, 2013</time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/rspec/'>rspec</a>, <a class='category' href='/blog/categories/ruby/'>ruby</a>


</div>
    </div>
		<p><a href="http://aaronkromer.com/blog/2013-07-17-monitoring-specific-messages-in-rspec.html">Last time</a> it was demonstrated how it is possible to monitor only a desired
message expectations. While that technique is useful for a vast majority of
use cases, sometimes you need a bit more complexity.</p>

<p>Say for example, the desire is to verify the state of the provided parameter.
As in this very contrived example (<em>Update: 2013-07-28 Paired down example to
only show test and not implementation</em>):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">describe</span> <span class="no">Factory</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">context</span> <span class="s1">&#39;making sure current stock is ready&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">it</span> <span class="s1">&#39;only fixes broken widgets&#39;</span> <span class="k">do</span>
</span><span class='line'>      <span class="c1"># Setup code</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">states</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>      <span class="n">expect</span><span class="p">(</span><span class="n">mechanic</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:fix</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">widget</span><span class="o">|</span>
</span><span class='line'>        <span class="n">states</span> <span class="o">&lt;&lt;</span> <span class="n">widget</span><span class="o">.</span><span class="n">broken?</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">expect</span><span class="p">{</span> <span class="n">factory</span><span class="o">.</span><span class="n">perform_maintenance</span> <span class="p">}</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">{</span><span class="n">states</span><span class="p">}</span><span class="o">.</span><span class="n">to</span> <span class="o">[</span><span class="kp">true</span><span class="o">]</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This leverages the <a href="https://www.relishapp.com/rspec/rspec-mocks/v/2-14/docs/method-stubs/stub-with-substitute-implementation">stub with substitute implementation</a>
provided by RSpec mocks. It can also be used with the <code>allow</code> syntax.</p>

<p>While the above version has it&#8217;s uses, it tends to hide some of the intent in
the closure manipulation. A slightly more expressive method is just to add
the state expectation in the block:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">expect</span><span class="p">(</span><span class="n">mechanic</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:fix</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">widget</span><span class="o">|</span>
</span><span class='line'>  <span class="n">expect</span><span class="p">(</span><span class="n">widget</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">be_broken</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This last technique is great for setting up generic message stubs which require
that something with specific state is provided. By adding it to a generic
<code>allow</code>, it ensures when the contract is broken anywhere in the code under test,
the test will properly fail. (<em>Update 2013-07-30: seems there is an
<a href="https://github.com/rspec/rspec-mocks/pull/382">issue</a> with this technique when
combined with
<a href="https://www.relishapp.com/rspec/rspec-mocks/v/2-14/docs/message-expectations/calling-the-original-method"><code>and_call_original</code></a></em>)</p>

		
		
	</div>

<div class="meta">
	
</div>
</article>

<nav id="pagenavi">
    
    
        <a href="/blog/page/2/" class="next">Next</a>
    
    <div class="center"><a href="/blog/archives">Blog Archives</a></div>
</nav>

    </div>
    <footer id="footer">
    <div style="display:inline">
  <p>
    Copyright &copy; 2014

    Aaron Kromer
.
    All content on this site is available under a <a href="http://creativecommons.org/publicdomain/zero/1.0/">CC0 license</a>.
  </p>
  <p>
    Powered by <a href="http://octopress.org">Octopress</a> |
    Theme based on <a href="http://github.com/panks/fabric">fabric</a> by <a href="http://panks.me">Pankaj Kumar</a>
  </p>
</div>


    </footer>
    <script src="/javascripts/fabric.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->






<!-- end toload --> 
</div>
</div>
<script src="/javascripts/jquery.ui.totop.js" type="text/javascript"></script>
<script type="text/javascript">
/*<![CDATA[*/
;(function($){$().UItoTop({easingType:'easeOutCirc'});})(jQuery); 
/*]]>*/
</script><!-- remove it to remove the scroll to top button -->
</body>
</html>
